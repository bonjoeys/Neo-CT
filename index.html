<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="noindex, nofollow" name="robots"/>
<title>
   Priorisons le projet Neo-CT
  </title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js">
</script>
<style>
   :root {
            --sidebar-width: 260px;
            --nord0: #2e3440;
            --nord4: #d8dee9;
            --nord6: #eceff4;
            --nord8: #88c0d0;
            --nord9: #81a1c1;
            --nord10: #5e81ac;
            --nord11: #bf616a; /* P1 & Error */
            --nord12: #d08770; /* P2 & Titre */
            --nord13: #ebcb8b; /* P3 */
            --nord14: #a3be8c; /* Success */
            --grey: #4c566a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #f8f9fa;
            color: #3b4252;
            margin: 0;
            padding-bottom: 80px; /* Space for bulk action bar */
        }

        /* === STRUCTURE : SIDEBAR & CONTENT === */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--sidebar-width);
            background-color: var(--nord0);
            color: var(--nord6);
            padding: 20px;
            box-sizing: border-box;
            transition: transform 0.3s ease-in-out;
            z-index: 200;
            overflow-y: auto;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
        }

        body.sidebar-collapsed .sidebar {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }
        body.sidebar-collapsed .main-content {
            margin-left: 0;
        }

        .sidebar h2 {
            text-align: center;
            color: var(--nord8);
            margin-top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #db-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--grey);
            transition: background-color: 0.3s;
        }
        #db-status-indicator.status-ok {
            background-color: var(--nord14);
        }
        #db-status-indicator.status-error {
            background-color: var(--nord11);
        }


        .tabs-nav {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .tab-link {
            padding: 12px 15px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.0em;
            color: var(--nord4);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            transition: background-color: 0.2s, color 0.2s;
        }
        .tab-link.active {
            background-color: var(--nord10);
            color: var(--nord6);
            font-weight: 600;
        }
        .tab-link:hover {
            background-color: #3b4252;
        }

        .sidebar-section-header {
            color: var(--nord8);
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            padding: 15px 15px 5px 15px;
            margin-top: 10px;
            border-bottom: 1px solid var(--grey);
        }

        .top-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            background-color: #fff;
            border-bottom: 1px solid var(--nord4);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .sidebar-toggle {
            font-size: 1.8em;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--nord0);
        }

        .content-tab {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-header { display: flex; align-items: center; gap: 25px; max-width: 1800px; margin: 0 auto; flex-grow: 1; }
        .logo {
            max-height: 55px;
            max-width: 150px;
            object-fit: contain;
        }
        .logo-neoct {
            max-height: 75px;
            max-width: 280px;
            transition: transform 0.2s ease-in-out;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05));
        }
        .logo-neoct:hover {
            transform: scale(1.03);
        }
        h1 { text-align: left; color: var(--nord12); font-weight: 600; margin: 0; flex-grow: 1; font-size: 1.7em; }
        .logo-group-right { display: flex; align-items: center; gap: 20px; }
        .page-container { display: flex; flex-direction: column; gap: 30px; max-width: 1800px; margin: 20px auto 0 auto; }
        .controls-container, .accueil-container, .mvp-container, .dnd-container, .admin-container, .mindmap-container, .static-mindmap-container, .priority-mindmap-container, .detail-level-container /* AJOUTÉ */ { background-color: #ffffff; padding: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); border-radius: 12px; border: 1px solid var(--nord4); }
        .controls-container h2, .mvp-container h2, .dnd-container h2, .admin-container h2, .mindmap-container h2, .static-mindmap-container h2, .priority-mindmap-container h2, .detail-level-container h2 /* AJOUTÉ */ { margin-top: 0; font-size: 1.4em; color: var(--nord0); }

        /* === DASHBOARD STYLES === */
        #kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background-color: var(--nord6);
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid var(--nord9);
        }
        .kpi-card .value {
            font-size: 2.2em;
            font-weight: 600;
            color: var(--nord0);
            margin: 0;
        }
        .kpi-card .label {
            font-size: 0.9em;
            color: var(--grey);
            margin: 5px 0 0 0;
        }
        #charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        .chart-wrapper {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        }
        .chart-wrapper h3 {
            margin-top: 0;
            text-align: center;
            color: var(--grey);
        }
        .chart-legend-filter {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--grey);
        }
        .legend-item-box {
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .legend-item.active .legend-item-box, .legend-item:hover .legend-item-box {
            opacity: 1;
        }
        .legend-item.active {
            font-weight: 600;
            color: var(--nord0);
        }
        /* Style Tooltip générique */
        .kpi-tooltip {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            transform: translate(-50%, -100%);
            margin-bottom: -10px;
            background-color: var(--nord0);
            color: var(--nord6);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: auto;
            min-width: 200px;
            max-width: 450px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 9999;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .kpi-tooltip.visible {
            visibility: visible;
            opacity: 1;
        }
        .kpi-tooltip ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }
        .kpi-tooltip li {
            padding: 3px 0;
            white-space: nowrap;
        }
        .kpi-tooltip .tooltip-content p,
        .kpi-tooltip .tooltip-content ul,
        .kpi-tooltip .tooltip-content ol {
            margin-bottom: 10px;
            white-space: normal;
        }
        .kpi-tooltip .tooltip-content ul,
        .kpi-tooltip .tooltip-content ol {
            padding-left: 20px;
        }
        .kpi-tooltip .tooltip-content code {
             background-color: var(--grey);
             padding: 2px 4px;
             border-radius: 3px;
             font-size: 0.9em;
        }
        .kpi-tooltip .tooltip-content strong {
            color: var(--nord8);
        }

        .planning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .filter-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-group {
            min-width: 200px;
        }
        .filter-group label { display: block; font-weight: 500; color: #4c566a; margin-bottom: 5px; font-size: 0.9em; }

        .project-counter-sync { font-size: 1.1em; color: var(--grey); font-weight: 500; white-space: nowrap; }
        .project-counter-sync strong { color: var(--nord12); }
        .counter-separator { margin: 0 10px; color: var(--nord4); }

        #tasks-table { width: 100%; border-collapse: collapse; }
        #tasks-table th, #tasks-table td { padding: 12px 8px; text-align: left; vertical-align: middle; }
        #tasks-table tbody tr { border-bottom: 1px solid var(--nord6); }
        #tasks-table th { font-size: 0.9em; text-transform: uppercase; color: #4c566a; padding-bottom: 12px; font-weight: 600; }
        #tasks-table th.action-cell { text-align: center; }
        .action-cell-content { display: flex; justify-content: center; align-items: center; gap: 5px;}

        /* NOUVEAUX STYLES POUR LE TABLEAU "NIVEAU DE DÉTAIL" */
        #detail-level-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #detail-level-table th, #detail-level-table td { padding: 10px 8px; text-align: left; vertical-align: middle; border-bottom: 1px solid var(--nord6); }
        #detail-level-table th { font-size: 0.9em; text-transform: uppercase; color: #4c566a; font-weight: 600; background-color: #f8f9fa; cursor: pointer; }
        #detail-level-table th:hover { background-color: var(--nord6); }
        #detail-level-table td { font-size: 0.95em; }
        #detail-level-table .description-progress-bar {
            width: 80px; height: 10px; background-color: var(--nord4); border-radius: 5px; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 5px;
        }
        #detail-level-table .description-progress-bar div {
            height: 100%; background-color: var(--nord14); transition: width 0.3s ease;
        }
        #detail-level-table .description-text { font-size: 0.85em; color: var(--grey); display: inline-block; vertical-align: middle;}
        #detail-level-table .no-subfeatures { color: var(--grey); font-style: italic; }
        /* FIN NOUVEAUX STYLES */


        .header-filter { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--nord4); background-color: #f8f9fa; box-sizing: border-box; }

        .add-feature-to-brick-btn {
            background-color: var(--nord14);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 28px;
            text-align: center;
            transition: background-color: 0.2s;
        }
        .add-feature-to-brick-btn:hover { background-color: #b5d5a2; }
        .edit-task-btn { background-color: var(--nord6); border: none; color: #4c566a; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .edit-task-btn:hover { background-color: var(--nord4); }
        .delete-row-btn { background: none; border: none; color: var(--nord11); font-size: 1.6em; cursor: pointer; padding: 4px 8px; opacity: 0.7; transition: opacity 0.2s, color 0.2s; line-height: 1; border-radius: 4px; }
        .delete-row-btn:hover { opacity: 1; color: var(--nord12); background-color: var(--nord6); }

        .button { display: inline-block; flex: none; width: auto; padding: 12px 18px; color: #ffffff; border: none; border-radius: 6px; font-size: 15px; font-weight: 500; cursor: pointer; transition: background-color: 0.2s, opacity 0.2s; text-align: center; }
        .button:disabled { background-color: var(--grey); opacity: 0.7; cursor: not-allowed; }
        .save-button { background-color: var(--nord14); } .save-button:hover:not(:disabled) { background-color: #b5d5a2; }
        .delete-button { background-color: var(--nord12); } .delete-button:hover:not(:disabled) { background-color: #e59a85; }
        .cancel-button { background-color: var(--nord11); } .cancel-button:hover:not(:disabled) { background-color: #d08770; }
        .add-button { background-color: var(--nord10); } .add-button:hover:not(:disabled) { background-color: var(--nord9); }
        .button-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin: 20px 0; }
        .modal-content h3 { margin-top: 0; }
        .modal-content label, .modal-content p { display: block; margin-top: 15px; font-weight: 500; color: #4c566a; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 10px; font-size: 1em; margin-top: 5px; border: 1px solid var(--nord4); border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;}
        .modal-actions .button { margin-top: 0; flex-grow: 0; }
        .modal-actions .delete-button { margin-right: auto; }
        .hidden { display: none; }

        #sub-features-view-modal .modal-content, #info-modal .modal-content {
            max-width: 900px;
        }

        .accueil-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-top: 20px; }
        .accueil-card { background-color: var(--nord6); padding: 25px; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--nord4); position: relative; }
        .accueil-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .accueil-card-icon { font-size: 3em; margin-bottom: 15px; }
        .accueil-card h3 { margin: 0; font-size: 1.3em; color: var(--nord0); }

        .tooltip-text-accueil {
            visibility: hidden; width: 220px; background-color: var(--nord0); color: #fff; text-align: center; border-radius: 6px; padding: 8px 12px;
            position: absolute; z-index: 10; bottom: 110%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s;
            font-size: 0.9em; font-weight: 400; pointer-events: none;
        }
        .tooltip-text-accueil::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: var(--nord0) transparent transparent transparent;
        }
        .accueil-card:hover .tooltip-text-accueil { visibility: visible; opacity: 1; }

        #features-section, #sub-features-section-modal { margin-top: 20px; border-top: 1px solid var(--nord4); padding-top: 15px; }
        #features-section h4, #sub-features-section-modal h4 { margin-top: 0; margin-bottom: 15px; color: var(--grey); font-size: 1.1em; }
        .feature-inputs { display: flex; gap: 10px; margin-top: 10px; }
        .feature-inputs input { flex-grow: 1; }
        #add-feature-btn, #add-sub-feature-btn { padding: 10px 15px; font-size: 14px; align-self: center; margin-top: 0; }

        .feature-action-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.7; padding: 4px;}
        .feature-action-btn:hover { opacity: 1; }

        .feature-inline-view-content { display: flex; flex-direction: column; align-items: flex-start; flex-grow: 1; }
        #tasks-table .features-list-display li {
            display: flex;
            align-items: center;
            padding: 4px;
            border-radius: 4px;
            transition: background-color: 0.2s;
            list-style: none;
            position: relative;
        }
        .feature-checkbox {
            margin-right: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        #tasks-table .features-list-display li:hover .feature-checkbox,
        .feature-checkbox:checked {
            opacity: 1;
        }
        #tasks-table .features-list-display li:hover {
            background-color: var(--nord6);
        }

        /* Sub-features styles */
        .view-sub-features-btn {
            background-color: var(--nord8);
            color: var(--nord0);
            border: none;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color: 0.2s;
        }
        .view-sub-features-btn:hover {
            background-color: var(--nord9);
        }

        #sub-features-view-modal-content {
            max-height: 65vh;
            overflow-y: auto;
            padding: 5px 15px 5px 5px;
            margin: 0 -15px;
        }

        #sub-features-view-modal-content .sub-features-list {
            list-style: none;
            padding: 10px 0;
            margin: 0;
        }
        #sub-features-view-modal-content .sub-features-list li {
            display: grid;
            grid-template-columns: 30% 70%;
            gap: 15px;
            align-items: start;
            padding: 15px 0;
            font-size: 0.9em;
            border-bottom: 1px solid var(--nord4);
        }
         #sub-features-view-modal-content .sub-features-list li:last-child {
            border-bottom: none;
        }
        .sub-feature-name {
            font-weight: 500;
            color: var(--nord0);
        }
        .sub-feature-description {
            color: var(--grey);
            font-style: normal;
            font-size: 1em;
            padding-left: 15px;
            border-left: 2px solid var(--nord4);
        }
        .sub-feature-description p { margin: 0 0 10px 0; }
        .sub-feature-description ul { margin: 0; padding-left: 20px; }


        #edit-sub-features-list {
            list-style: none;
            padding: 5px;
            box-sizing: border-box;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
            background-color: var(--nord6);
            border-radius: 4px;
        }
        #edit-sub-features-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--nord4);
        }
        #edit-sub-features-list li:last-child { border-bottom: none; }
        #edit-sub-features-list .sub-feature-details { flex-grow: 1; }
        #edit-sub-features-list .sub-feature-details p {
            font-size: 0.85em; color: var(--grey); margin: 2px 0 0 0; font-weight: 400;
        }
        #edit-sub-features-list .sub-feature-actions { display: flex; align-items: center; flex-shrink: 0; margin-left: 10px; }
        .delete-sub-feature-btn, .edit-sub-feature-btn {
            background: none; border: none;
            font-size: 1.3em; cursor: pointer; opacity: 0.7;
            padding: 2px 6px;
        }
        .delete-sub-feature-btn:hover, .edit-sub-feature-btn:hover { opacity: 1; }
        .delete-sub-feature-btn { color: var(--nord11); }
        .edit-sub-feature-btn { color: var(--nord9); }

        .priority-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            margin-right: 8px;
        }
        .priority-p1 { background-color: var(--nord11); }
        .priority-p2 { background-color: var(--nord12); }
        .priority-p3 { background-color: var(--nord13); }
        .priority-adefinir { background-color: var(--grey); }
        #tasks-table .features-list-display, #tasks-table .sub-features-list { list-style: none; padding: 0; margin: 0; }

        .status-message {
            text-align: center;
            padding: 40px 20px;
            background-color: var(--nord6);
            border-radius: 8px;
            border: 1px dashed var(--nord4);
        }
        .error-message {
            background-color: #bf616a20;
            border-color: var(--nord11);
            color: var(--nord0);
        }
        .error-message h3 { color: var(--nord11); margin-top: 0;}
        .error-message code {
            display: block;
            background-color: var(--nord4);
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        #toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-size: 1em;
            font-weight: 500;
            z-index: 2000;
            transition: bottom 0.5s ease-in-out, transform 0.5s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #toast-notification.show { bottom: 20px; }

        #bulk-action-bar {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--nord0);
            color: var(--nord6);
            padding: 15px 25px;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: bottom 0.3s ease-in-out;
            z-index: 1500;
        }
        #bulk-action-bar.show {
            bottom: 0;
        }
        #bulk-selection-counter {
            font-weight: 500;
        }


        #loader-container { padding: 30px; }
        #loader-container h1 { color: var(--nord0); font-size: 1.4em; }
        #loader-steps {
            list-style: none; padding: 0; margin-top: 20px; max-width: 400px;
            margin-left: auto; margin-right: auto; text-align: left;
        }
        #loader-steps li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid var(--nord4); opacity: 0.5;
            transition: opacity 0.3s;
        }
        #loader-steps li:last-child { border-bottom: none; }
        #loader-steps li.active { opacity: 1; font-weight: 500; }
        #loader-steps .status::before { content: '...'; font-weight: bold; color: var(--grey); display: inline-block; }
        #loader-steps li.active .status::before {
            content: ''; width: 16px; height: 16px; border: 2px solid var(--nord10);
            border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite; box-sizing: border-box;
        }
        #loader-steps li.success .status::before { content: '✔'; animation: none; color: var(--nord14); border: none; font-size: 1.2em; }
        #loader-steps li.error .status::before { content: '✖'; animation: none; color: var(--nord11); border: none; font-size: 1.2em; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Styles pour le Drag and Drop */
        .dnd-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .dnd-column {
            background-color: var(--nord6);
            border-radius: 8px;
            padding: 15px;
            min-height: 50vh;
            display: flex;
            flex-direction: column;
        }
        .dnd-column h3 {
            margin-top: 0;
            text-align: center;
            color: var(--nord0);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--nord4);
        }
        .dnd-list {
            min-height: 50px;
            flex-grow: 1;
        }
        .dnd-item {
            background-color: #fff;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 5px solid;
        }
        .dnd-item.p1 { border-color: var(--nord11); }
        .dnd-item.p2 { border-color: var(--nord12); }
        .dnd-item.p3 { border-color: var(--nord13); }
        .dnd-item.adefinir { border-color: var(--grey); }

        .dnd-item strong {
            display: block;
            margin-bottom: 5px;
            color: var(--nord0);
        }
        .dnd-item span {
            font-size: 0.85em;
            color: var(--grey);
        }
        .dnd-item .sub-features-count {
            font-size: 0.8em;
            color: var(--nord0);
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
            background-color: var(--nord8);
            border-radius: 10px;
            padding: 2px 8px;
            cursor: pointer;
            transition: background-color: 0.2s;
        }
        .dnd-item .sub-features-count:hover {
             background-color: var(--nord9);
        }
        .dnd-item.sortable-ghost {
            opacity: 0.4;
            background-color: var(--nord8);
        }

        .dnd-item.sub-feature-item {
            background-color: #e5e9f0;
        }
        .dnd-item.sub-feature-item .parent-feature-name {
            font-size: 0.8em;
            color: var(--nord9);
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        /* DnD View Switcher */
        .view-switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .switch-label {
            font-weight: 500;
            color: var(--grey);
            cursor: pointer;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--nord9);
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--nord10);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--nord10);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .slider.round {
            border-radius: 28px;
        }
        .slider.round:before {
            border-radius: 50%;
        }


        /* Styles for MVP View */
        .mvp-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .mvp-filter-card {
            background-color: var(--nord6);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .mvp-filter-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .mvp-filter-card.active {
            background-color: var(--nord8);
            color: var(--nord0);
            font-weight: 600;
            border-color: var(--nord10);
        }
        .mvp-brique-section {
            margin-bottom: 30px;
        }
        .mvp-brique-section h3 {
            color: var(--nord10);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--nord6);
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .mvp-tag-header {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--grey);
            font-size: 1.1em;
            font-weight: 600;
            padding-left: 10px;
            border-left: 3px solid var(--nord8);
        }
        .mvp-features-list {
            list-style: none;
            padding-left: 20px; /* Indent features under tag */
        }
        .mvp-features-list li {
            background-color: var(--nord6);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 5px solid var(--nord11);
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mvp-features-list li .tags-container-display {
            margin-top: 0; /* Override default margin */
            justify-content: flex-end;
        }

        /* Styles for Multi-Select Dropdown */
        .multi-select-container {
            position: relative;
            width: 100%;
            min-width: 200px;
            border: 1px solid var(--nord4);
            border-radius: 6px;
            background-color: #f8f9fa;
        }
        .select-box {
            padding: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .select-box span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        .checkboxes {
            position: absolute;
            background-color: #fff;
            border: 1px solid var(--nord4);
            border-radius: 6px;
            width: 100%;
            z-index: 101;
            margin-top: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .checkboxes label {
            display: block;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: normal;
            font-size: 1em;
            margin-bottom: 0;
            color: var(--nord0);
        }
        .checkboxes label:hover {
            background-color: var(--nord6);
        }
        .checkboxes input[type="checkbox"] {
            margin-right: 8px;
        }

        .multi-select-search {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: none;
            border-bottom: 1px solid var(--nord4);
            background-color: var(--nord6);
        }
        .multi-select-search:focus {
            outline: 1px solid var(--nord9);
        }
        .multi-select-list {
            max-height: 160px;
            overflow-y: auto;
            position: relative;
        }

        /* Styles for Tags */
        .tags-container-display, .tags-container-modal-view, .tags-container-modal-edit {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        .tag-item {
            background-color: var(--nord8);
            color: var(--nord0);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .remove-tag-btn {
            background: none;
            border: none;
            color: var(--nord0);
            cursor: pointer;
            opacity: 0.6;
            font-size: 1.1em;
            padding: 0;
            line-height: 1;
        }
        .remove-tag-btn:hover { opacity: 1; }

        .tags-editor {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
            position: relative;
        }
        .tags-editor .tag-input, .tags-editor .tag-select {
            flex-grow: 1;
            border: none;
            background: none;
            padding: 5px;
        }
        .tags-editor .tag-input:focus, .tags-editor .tag-select:focus { outline: none; }

        .tags-editor .add-tag-btn {
            background-color: var(--nord10);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        .dnd-item .tags-container-display { margin-bottom: 5px; }

        /* Admin Page Styles */
        .admin-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        .admin-section { margin-bottom: 30px; }
        .admin-section h3 {
            color: var(--nord9);
            border-bottom: 2px solid var(--nord6);
            padding-bottom: 10px;
        }
        .admin-add-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .admin-add-form input {
            flex-grow: 1;
        }
        .admin-list {
            list-style: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .admin-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            background-color: var(--nord6);
            margin-bottom: 8px;
        }
        .admin-item-actions button {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.7;
            font-size: 1.2em;
            margin-left: 8px;
        }
        .admin-item-actions button:hover {
            opacity: 1;
        }
        .anomaly-group {
            margin-bottom: 20px;
        }
        .anomaly-group h4 {
            color: var(--nord12);
        }
        .anomaly-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: #fff;
            border: 1px solid var(--nord6);
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .anomaly-info {
            font-size: 0.9em;
        }
        .anomaly-info strong {
            color: var(--nord0);
        }
        .anomaly-info span {
            color: var(--grey);
        }

        /* Interactive Mindmap */
        .interactive-mindmap-container {
            padding-left: 20px;
            overflow-x: auto;
        }
        .mindmap-list {
            list-style: none;
            padding-left: 25px;
            position: relative;
        }
        .mindmap-root > li {
            margin-bottom: 20px;
        }
        .mindmap-list li {
            padding: 5px 0;
            position: relative;
        }
        .mindmap-node-container {
            display: flex;
            align-items: center;
        }
        .mindmap-node {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color: 0.2s;
            font-weight: 500;
            border: 1px solid var(--nord4);
            background-color: #fff;
            min-width: 150px;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            white-space: nowrap;
        }
        .mindmap-node:hover {
            background-color: var(--nord6);
        }
        .mindmap-node.brick, .mindmap-node.priority {
            font-size: 1.2em;
            background-color: var(--nord8);
            color: var(--nord0);
            border-color: var(--nord9);
        }
        .mindmap-node.feature {
            font-size: 1.0em;
            background-color: var(--nord13);
             color: var(--nord0);
        }
        .mindmap-node.sub-feature {
            font-size: 0.9em;
            color: var(--grey);
            font-weight: 400;
             background-color: var(--nord6);
        }
        .mindmap-node.sub-feature:hover {
            text-decoration: underline;
        }

        .mindmap-toggle {
            display: inline-block;
            width: 20px;
            text-align: center;
            margin-right: 5px;
            font-family: monospace;
            transition: transform 0.2s ease-in-out;
        }
        .mindmap-toggle.hidden {
            visibility: hidden;
        }

        /* Connecting lines */
        .mindmap-list {
            padding-left: 40px;
        }
        .mindmap-node-container {
            position: relative;
        }
        .mindmap-node-container::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            border-top: 2px solid var(--nord4);
            width: 20px;
            height: 0;
        }
        .mindmap-list > li {
            position: relative;
        }
        .mindmap-list > li::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 0;
            border-left: 2px solid var(--nord4);
            width: 0;
            height: 100%;
        }
        .mindmap-list > li:last-child::before {
            height: 50%;
        }
        .mindmap-root {
            padding-left: 0;
        }
        .mindmap-root > li::before, .mindmap-root > li > .mindmap-node-container::before {
            display: none;
        }
    
        
        /* Styles pour les sous-onglets d'Analyse des Offres */
        .sub-tab-nav {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--nord4);
            margin-bottom: 20px;
        }
        .sub-tab-link {
            padding: 10px 18px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1em;
            color: var(--grey);
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .sub-tab-link.active {
            color: var(--nord10);
            border-bottom-color: var(--nord10);
            font-weight: 600;
        }
        .sub-tab-link:hover { color: var(--nord0); }
        
        /* Navigation des fournisseurs */
        .vendor-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background-color: var(--nord6);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .vendor-tab-link {
            padding: 8px 15px; border: none; border-radius: 6px;
            background-color: #fff; color: var(--grey); cursor: pointer;
            font-weight: 500; transition: background-color 0.2s, color 0.2s;
        }
        .vendor-tab-link:hover { background-color: var(--nord4); }
        .vendor-tab-link.active {
            background-color: var(--nord9);
            color: #fff;
            font-weight: 600;
        }
        .vendor-content-wrapper {
            padding: 15px;
            border: 1px solid var(--nord6);
            border-radius: 8px;
        }
        .ao-textarea {
            width: 100%; min-height: 150px; border: 1px solid var(--nord4);
            border-radius: 6px; padding: 10px; font-family: inherit; font-size: 0.95em;
        }

        /* --- STYLES POUR AO GRILLE (Traduit de Tailwind) --- */
        .ao-container { padding: 5px; }
        .ao-header {
            margin-bottom: 25px; padding-bottom: 15px;
            border-bottom: 2px solid var(--nord6);
        }
        .ao-header h1 {
            font-size: 2em; font-weight: 600;
            color: var(--nord10); margin: 0;
        }
        .ao-header p { margin-top: 8px; font-size: 1.1em; color: var(--grey); }

        .ao-sommaire {
            margin-bottom: 30px; padding: 20px;
            background-color: var(--nord6);
            border-radius: 8px; border: 1px solid var(--nord4);
        }
        .ao-sommaire h2 {
            font-size: 1.3em; font-weight: 600; color: var(--nord0);
            margin-top: 0; margin-bottom: 15px;
        }
        .ao-sommaire ul {
            list-style: none; padding: 0; margin: 0;
            display: flex; flex-wrap: wrap; gap: 10px 20px;
        }
        .ao-sommaire a { color: var(--nord10); font-weight: 500; text-decoration: none; }
        .ao-sommaire a:hover { text-decoration: underline; }
        .ao-sommaire a.bold { color: var(--nord9); font-weight: 700; }

        .ao-section-card {
            background-color: #fff; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
            border: 1px solid var(--nord4); margin-top: 30px;
        }
        .ao-section-card-header {
            margin-top: 0; font-size: 1.8em; font-weight: 600;
            color: var(--nord9); margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 2px solid var(--nord6);
        }

        .ao-table-wrapper { overflow-x: auto; }
        .ao-table { width: 100%; min-width: 1000px; border-collapse: collapse; }
        .ao-table thead { background-color: var(--nord6); }
        .ao-table th, .ao-table td {
            padding: 12px 15px; border-bottom: 1px solid var(--nord4);
            text-align: left; vertical-align: middle;
        }
        .ao-table th {
            font-size: 0.8em; font-weight: 600;
            color: var(--grey); text-transform: uppercase;
        }
        .ao-table .text-center { text-align: center; }
        .ao-table .col-critere { font-size: 0.95em; font-weight: 500; color: var(--nord0); }
        .ao-table .col-critere-light { font-weight: 400; color: var(--grey); }
        .ao-table .row-total { background-color: var(--nord6); font-weight: 700; }
        .ao-table .row-total td { color: var(--nord0); }
        .ao-table .cost-note { font-size: 0.85em; color: var(--grey); }
        .ao-table .nogo-note { font-size: 0.85em; color: var(--nord11); font-weight: 600; }

        .star-rating {
            font-size: 1.4rem; color: var(--nord13); /* Yellow */
            letter-spacing: 0.1em;
        }
        .star-rating-placeholder { color: var(--grey); font-size: 0.9em; font-style: italic; }

        .ao-accordion-group { margin-top: 30px; display: flex; flex-direction: column; gap: 20px; }
        .ao-accordion-item {
            background-color: #fff; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
            border: 1px solid var(--nord4); overflow: hidden;
        }
        .ao-accordion-button {
            width: 100%; text-align: left; padding: 20px 25px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: #fff; border: none;
            border-bottom: 1px solid var(--nord6);
            cursor: pointer; transition: background-color 0.2s;
        }
        .ao-accordion-item:first-child .ao-accordion-button { background-color: var(--nord6); }
        .ao-accordion-button:hover { background-color: var(--nord4); }
        .ao-accordion-button h2 {
            font-size: 1.8em; font-weight: 600;
            color: var(--nord10); margin: 0;
        }
        .ao-accordion-button.placeholder h2 { color: var(--grey); }
        .ao-accordion-button svg {
            width: 24px; height: 24px; color: var(--nord10);
            transition: transform 0.3s ease;
        }
        .ao-accordion-button.open svg { transform: rotate(180deg); }

        .ao-accordion-content {
            display: none; overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0; padding: 0;
        }
        .ao-accordion-content.open { display: block; max-height: 10000px; }
        .ao-accordion-content-inner { padding: 25px 30px; display: flex; flex-direction: column; gap: 30px; }
        .ao-accordion-section h3 {
            padding: 12px; font-size: 1.1em; font-weight: 600;
            color: var(--nord0); border-radius: 6px;
            background-color: var(--nord6); margin: 0 0 20px 0;
        }
        .ao-accordion-section.sec-go-nogo { background-color: #ffeb99; }
        .ao-accordion-section.sec-main { background-color: var(--nord14); color: var(--nord0); }

        .ao-grid-row {
            display: grid; grid-template-columns: repeat(12, 1fr);
            gap: 20px; padding: 15px 0; border-bottom: 1px solid var(--nord6);
        }
        .ao-grid-row:last-child { border-bottom: none; }
        .ao-grid-label { grid-column: span 12; }
        .ao-grid-label label { font-size: 1.05em; font-weight: 600; color: var(--nord0); display: block; }
        .ao-grid-label p { font-size: 0.85em; color: var(--grey); margin: 5px 0 0 0; }
        .ao-grid-analysis { grid-column: span 12; }
        .ao-grid-source { grid-column: span 12; }
        @media (min-width: 768px) {
            .ao-grid-label { grid-column: span 4; }
            .ao-grid-analysis { grid-column: span 5; }
            .ao-grid-source { grid-column: span 3; }
        }

        .ao-pill {
            display: inline-block; padding: 5px 12px; border-radius: 15px;
            font-weight: 600; font-size: 0.9em; text-align: center; width: 130px;
        }
        .ao-pill.go { background-color: #a3be8c40; color: #a3be8c; border: 1px solid #a3be8c; }
        .ao-pill.no-go { background-color: #bf616a40; color: var(--nord11); border: 1px solid var(--nord11); }
        .ao-pill.na { background-color: var(--nord6); color: var(--grey); border: 1px solid var(--nord4); }
        .ao-pill.lot { background-color: #81a1c140; color: var(--nord9); border: 1px solid var(--nord9); }
        .ao-pill.placeholder { color: var(--grey); background-color: var(--nord6); font-style: italic; }

        .ao-analysis-card {
            background-color: #fff; border: 1px solid var(--nord6);
            border-radius: 6px; padding: 10px 15px;
            font-size: 0.95em; line-height: 1.5; color: var(--nord0);
        }
        .ao-analysis-card.placeholder { color: var(--grey); font-style: italic; }
        .ao-source-card {
            background-color: var(--nord6); border: 1px dashed var(--nord4);
            border-radius: 6px; padding: 8px 12px;
            font-size: 0.85em; color: var(--grey); font-style: italic;
        }
        
        .ao-tooltip-container { position: relative; cursor: pointer; }
        .ao-tooltip-text {
            visibility: hidden; width: 280px; background-color: var(--nord0);
            color: var(--nord6); text-align: left; border-radius: 6px;
            padding: 8px 12px; position: absolute; z-index: 10;
            bottom: 125%; left: 50%; margin-left: -140px;
            opacity: 0; transition: opacity 0.3s;
            font-size: 0.85em; font-weight: 400; line-height: 1.4; white-space: normal;
        }
        .ao-tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%;
            margin-left: -5px; border-width: 5px; border-style: solid;
            border-color: var(--nord0) transparent transparent transparent;
        }
        .ao-tooltip-container:hover .ao-tooltip-text { visibility: visible; opacity: 1; }

        .ao-podium-container {
            display: flex; align-items: flex-end; justify-content: center;
            height: 250px; gap: 10px; margin: 40px auto; flex-wrap: wrap;
        }
        .ao-podium-step {
            display: flex; flex-direction: column; align-items: center;
            justify-content: flex-end; width: 140px;
            background-color: var(--grey); border-radius: 8px 8px 0 0;
            padding: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center; color: white; position: relative; transition: all 0.3s ease;
        }
        .ao-podium-step.gold { height: 100%; background-color: var(--nord13); color: var(--nord0); }
        .ao-podium-step.silver { height: 80%; background-color: var(--nord4); color: var(--nord0); }
        .ao-podium-step.bronze { height: 60%; background-color: var(--nord12); }
        .ao-podium-step.unranked { height: 40%; background-color: var(--grey); }
        .ao-podium-rank { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
        .ao-podium-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .ao-podium-score { font-size: 1rem; }
        .ao-podium-score .star-rating { font-size: 1.2rem; }
        .ao-podium-score .unranked-text-nogo { color: var(--nord11); font-size: 0.9em; font-weight: 600; }
        .ao-podium-score .unranked-text-eval { color: var(--nord4); font-size: 0.9em; }
  </style>
</head>
<body>
<div class="sidebar" id="sidebar">
<h2>
<span id="db-status-indicator" title="Statut de la connexion">
</span>
    Navigation
   </h2>
<div class="tabs-nav">
<button class="tab-link active" data-tab="accueil-container">
     🏠 Accueil
    </button>
<div class="sidebar-section-header">
     Gestion &amp; Saisie
    </div>
<button class="tab-link" data-tab="controls-container">
     📝 Gestion des applis, modules et fonctionnalités
    </button>
<button class="tab-link" data-tab="dnd-container">
     ⚖️ Priorisation
    </button>
<button class="tab-link" data-tab="reorg-container">
     🏗️ Réorganisation Fonctionnalités
    </button>
<button class="tab-link" data-tab="admin-container">
     ⚙️ Administration
    </button>
<div class="sidebar-section-header">
     Analyse &amp; Visualisation
    </div>
<button class="tab-link" data-tab="mvp-container">
     🚀 Vue MVP (P1)
    </button>
<button class="tab-link" data-tab="mindmap-container">
     🧱 Carte Structurelle
    </button>
<button class="tab-link" data-tab="priority-mindmap-container">
     📊 Carte par Priorité
    </button>
<button class="tab-link" data-tab="detail-level-container">
     📊 Niveau de Détail
    </button>
<button class="tab-link" data-tab="analyse-offres-container">
     ⚖️ Analyse AO Agenda
    </button>
<button class="tab-link" data-tab="static-mindmap-container">
     🖼️ Carte Statique
    </button>
<div class="sidebar-section-header">
     Information
    </div>
<button class="tab-link" data-tab="documentation-container">
     📚 Documentation
    </button>
</div>
</div>
<div class="main-content" id="main-content">
<div class="top-bar">
<button class="sidebar-toggle" id="sidebar-toggle">
     ☰
    </button>
<div class="main-header">
<img alt="Logo SGS" class="logo" onerror="this.style.display='none'" src="SGS_Logo.png"/>
<h1>
      Priorisons le projet Neo-CT
     </h1>
<div class="logo-group-right">
<img alt="Logo Securitest" class="logo" onerror="this.style.display='none'" src="https://www.securitest.fr/media/securitest-logo.svg"/>
<img alt="Logo Auto Sécurité" class="logo" onerror="this.style.display='none'" src="https://www.autosecurite.com/media/auto-securite-logo.svg"/>
<img alt="Logo Neo-CT" class="logo logo-neoct" onerror="this.style.display='none'" src="Logo_neoct.png"/>
</div>
</div>
</div>
<div class="page-container">
<div class="accueil-container content-tab" id="accueil-container">
<h2>
      📊 Tableau de Bord Synthétique
     </h2>
<div id="kpi-container">
</div>
<div id="charts-container">
<div class="chart-wrapper">
<h3>
        Répartition par Priorité
       </h3>
<canvas id="priorityChart">
</canvas>
</div>
<div class="chart-wrapper">
<h3 id="p1ByBrickChartTitle">
        Modules par Appli
       </h3>
<div class="chart-legend-filter" id="p1ByBrickFilter">
</div>
<canvas id="p1ByBrickChart">
</canvas>
</div>
<div class="chart-wrapper">
<h3>
        Modules par Étiquette
       </h3>
<canvas id="featuresByTagChart">
</canvas>
</div>
</div>
</div>
<div class="controls-container content-tab hidden" id="controls-container">
<h2>
      Gestion des applis, modules et fonctionnalités
     </h2>
<div class="planning-header">
<div class="filter-controls">
<div class="filter-group">
<label for="brick-filter-planning">
         Filtrer par appli
        </label>
<div class="multi-select-container" id="brick-filter-planning">
<div class="select-box">
<span>
           Toutes les applis
          </span>
</div>
<div class="checkboxes hidden" id="brick-checkboxes-planning">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="tag-filter-planning">
         Filtrer par étiquette
        </label>
<div class="multi-select-container" id="tag-filter-planning">
<div class="select-box">
<span>
           Toutes les étiquettes
          </span>
</div>
<div class="checkboxes hidden" id="tag-checkboxes-planning">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="module-filter-planning">
         Filtrer par module
        </label>
<div class="multi-select-container" id="module-filter-planning">
<div class="select-box">
<span>
           Tous les modules
          </span>
</div>
<div class="checkboxes hidden" id="module-checkboxes-planning">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="feature-filter-planning">
         Recherche globale
        </label>
<input class="header-filter" id="feature-filter-planning" placeholder="Appli, module, fonction..." type="text"/>
</div>
</div>
<p class="project-counter-sync" id="planning-counter">
</p>
</div>
<div class="status-message" id="loader-container">
<h1>
       Préparation de l'application...
      </h1>
<ul id="loader-steps">
<li id="step1">
<span>
         Connexion à la base de données
        </span>
<span class="status">
</span>
</li>
<li id="step2">
<span>
         Chargement des paramètres
        </span>
<span class="status">
</span>
</li>
<li id="step3">
<span>
         ChargEMENT des données
        </span>
<span class="status">
</span>
</li>
<li id="step4">
<span>
         Affichage de l'interface
        </span>
<span class="status">
</span>
</li>
</ul>
</div>
<div class="hidden" id="table-wrapper">
</div>
<div class="button-group hidden" id="button-group-wrapper">
<button class="button add-button" id="add-task-btn">
       Ajouter une appli
      </button>
<button class="button add-button" id="add-module-btn" style="background-color: var(--nord9);">
       Ajouter un module
      </button>
</div>
</div>
<div class="dnd-container content-tab hidden" id="dnd-container">
<h2>
      Priorisation
     </h2>
<div class="planning-header">
<div class="filter-controls">
<div class="filter-group">
<label for="brick-filter-dnd">
         Filtrer par appli
        </label>
<div class="multi-select-container" id="brick-filter-dnd">
<div class="select-box">
<span>
           Toutes les applis
          </span>
</div>
<div class="checkboxes hidden" id="brick-checkboxes-dnd">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="tag-filter-dnd">
         Filtrer par étiquette
        </label>
<div class="multi-select-container" id="tag-filter-dnd">
<div class="select-box">
<span>
           Toutes les étiquettes
          </span>
</div>
<div class="checkboxes hidden" id="tag-checkboxes-dnd">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="module-filter-dnd">
         Filtrer par module
        </label>
<div class="multi-select-container" id="module-filter-dnd">
<div class="select-box">
<span>
           Tous les modules
          </span>
</div>
<div class="checkboxes hidden" id="module-checkboxes-dnd">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="feature-filter-dnd">
         Recherche globale
        </label>
<input class="header-filter" id="feature-filter-dnd" placeholder="Module, fonction..." type="text"/>
</div>
</div>
<div class="view-switch-container">
<label class="switch-label" for="dnd-view-switch">
        Modules
       </label>
<label class="switch">
<input id="dnd-view-switch" type="checkbox"/>
<span class="slider round">
</span>
</label>
<label class="switch-label" for="dnd-view-switch">
        Fonctionnalités
       </label>
</div>
</div>
<div class="dnd-board">
<div class="dnd-column">
<h3>
        Priorité 1
       </h3>
<div class="dnd-list" data-priority="P1" id="dnd-p1">
</div>
</div>
<div class="dnd-column">
<h3>
        Priorité 2
       </h3>
<div class="dnd-list" data-priority="P2" id="dnd-p2">
</div>
</div>
<div class="dnd-column">
<h3>
        Priorité 3
       </h3>
<div class="dnd-list" data-priority="P3" id="dnd-p3">
</div>
</div>
<div class="dnd-column">
<h3>
        À définir
       </h3>
<div class="dnd-list" data-priority="À définir" id="dnd-adefinir">
</div>
</div>
</div>
</div>
<div class="dnd-container content-tab hidden" id="reorg-container">
<h2>
      Réorganisation des fonctionnalités
     </h2>
<div class="planning-header">
<div class="filter-controls">
<div class="filter-group">
<label for="brick-filter-reorg">
         Filtrer par appli
        </label>
<div class="multi-select-container" id="brick-filter-reorg">
<div class="select-box">
<span>
           Toutes les applis
          </span>
</div>
<div class="checkboxes hidden" id="brick-checkboxes-reorg">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="tag-filter-reorg">
         Filtrer par étiquette
        </label>
<div class="multi-select-container" id="tag-filter-reorg">
<div class="select-box">
<span>
           Toutes les étiquettes
          </span>
</div>
<div class="checkboxes hidden" id="tag-checkboxes-reorg">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="module-filter-reorg">
         Filtrer par module
        </label>
<div class="multi-select-container" id="module-filter-reorg">
<div class="select-box">
<span>
           Tous les modules
          </span>
</div>
<div class="checkboxes hidden" id="module-checkboxes-reorg">
<input class="multi-select-search" placeholder="Rechercher..." type="text"/>
<div class="multi-select-list">
</div>
</div>
</div>
</div>
<div class="filter-group">
<label for="feature-filter-reorg">
         Recherche globale
        </label>
<input class="header-filter" id="feature-filter-reorg" placeholder="Module, fonction..." type="text"/>
</div>
</div>
</div>
<p style="margin-top: -15px; margin-bottom: 25px; color: var(--grey);">
      Glissez-déposez une fonctionnalité d'un module à un autre pour la ré-assigner.
     </p>
<div class="dnd-board" id="reorg-board">
</div>
</div>
<div class="mvp-container content-tab hidden" id="mvp-container">
<h2>
      MVP (P1)
     </h2>
<div class="mvp-filter-grid" id="mvp-filter-grid">
<div class="mvp-filter-card active" data-filter="all">
<h3>
        Tout voir
       </h3>
</div>
<div class="mvp-filter-card" data-filter="Adelsoft">
<h3>
        MVP Adelsoft
       </h3>
</div>
<div class="mvp-filter-card" data-filter="Agenda">
<h3>
        MVP Agenda
       </h3>
</div>
<div class="mvp-filter-card" data-filter="Pilote">
<h3>
        MVP Pilote
       </h3>
</div>
</div>
<div id="mvp-view-content">
</div>
</div>
<div class="admin-container content-tab hidden" id="admin-container">
<h2>
      Administration
     </h2>
<div class="admin-sections">
<div class="admin-section" id="admin-priorities">
<h3>
        Gestion des Priorités
       </h3>
<form class="admin-add-form" id="add-priority-form">
<input id="new-priority-name" placeholder="Nom de la priorité" required="" type="text"/>
<button class="button add-button" type="submit">
         Ajouter
        </button>
</form>
<ul class="admin-list" id="priorities-list">
</ul>
</div>
<div class="admin-section" id="admin-tags">
<h3>
        Gestion des Étiquettes
       </h3>
<form class="admin-add-form" id="add-tag-form">
<input id="new-tag-name" placeholder="Nom de l'étiquette" required="" type="text"/>
<button class="button add-button" type="submit">
         Ajouter
        </button>
</form>
<ul class="admin-list" id="tags-list">
</ul>
</div>
<div class="admin-section" id="admin-export">
<h3>
        Exporter les Données
       </h3>
<p>
        Sauvegardez l'ensemble des données du projet.
       </p>
<div class="button-group" style="justify-content: flex-start;">
<button class="button add-button" id="export-json-btn">
         Exporter en JSON
        </button>
<button class="button add-button" id="export-csv-btn">
         Exporter en CSV
        </button>
</div>
</div>
</div>
<div class="admin-section" id="admin-anomalies">
<h3>
       Supervision des Données (Anomalies)
      </h3>
<p>
       Cette section liste les incohérences potentielles dans les données. Cliquez sur un élément pour le corriger.
      </p>
<div id="anomalies-container">
</div>
</div>
</div>
<div class="mindmap-container content-tab hidden" id="mindmap-container">
<h2>
      🧱 Carte Structurelle
     </h2>
<div class="interactive-mindmap-container" id="interactive-mindmap-container">
</div>
</div>
<div class="priority-mindmap-container content-tab hidden" id="priority-mindmap-container">
<h2>
      📊 Carte par Priorité
     </h2>
<div class="interactive-mindmap-container" id="priority-mindmap-view">
</div>
</div>
<div class="detail-level-container content-tab hidden" id="detail-level-container">
<h2>
      📊 Niveau de Détail des Modules
     </h2>
<p>
      Ce tableau analyse la granularité et la description des fonctionnalités pour chaque module.
     </p>
<div id="detail-level-table-container">
</div>
</div>
<div class="admin-container content-tab hidden" id="analyse-offres-container">
<h2>
      ⚖️ Analyse AO Agenda
     </h2>
<div class="sub-tab-nav">
<button class="sub-tab-link active" data-subtab="reponses-soumissionnaires">
       Réponses des soumissionnaires
      </button>
<button class="sub-tab-link" data-subtab="grille-evaluation">
       Grille d'évaluation
      </button>
<button class="sub-tab-link" data-subtab="synthese-podium">
       Synthèse &amp; Podium
      </button>
</div>
<div class="sub-content-tab" id="reponses-soumissionnaires">
<p>
       Documents et notes sur les réponses reçues.
      </p>
<div class="vendor-nav">
<button class="vendor-tab-link active" data-vendor="actency">
        Actency
       </button>
<button class="vendor-tab-link" data-vendor="agendize">
        Agendize
       </button>
<button class="vendor-tab-link" data-vendor="itec">
        Itec
       </button>
<button class="vendor-tab-link" data-vendor="nexius">
        Nexius
       </button>
<button class="vendor-tab-link" data-vendor="simplybook">
        Simplybook
       </button>
<button class="vendor-tab-link" data-vendor="microsoft">
        Microsoft
       </button>
</div>
<div class="vendor-content-wrapper">
<div class="vendor-content" id="vendor-actency">
<h3>
         Actency
        </h3>
<a class="button add-button" href="https://sgs.sharepoint.com/sites/fr-it-insideit/serviceachats/Management%20des%20Achats/Forms/AllItems.aspx?id=%2Fsites%2Ffr%2Dit%2Dinsideit%2Fserviceachats%2FManagement%20des%20Achats%2FDocuments%20Administratifs%2FDocument%20RFP%20%5F%20IT%20SEC%20%5F%20RGPD%2FConsultations%2F2025%2FRFP%20%2D%20REFONTE%20AGENDA%20%2D%20WD%2017324%2FREPONSES%20RFP%2FACTENCY&amp;viewid=0d16130d%2Dc55c%2D4cb1%2D8da5%2D7e1f92f220e3&amp;CT=1751361905083&amp;OR=OWA%2DNT%2DMail&amp;CID=cd4c72fa%2D764b%2D052e%2Dac9a%2D8ad11d8aadda&amp;e=5%3Adb70ddaf8f4049279fa75a90ef3d7f42&amp;sharingv2=true&amp;fromShare=true&amp;at=9&amp;FolderCTID=0x0120008FEABFED2651E84D82FB0CFF22DD7750" style="margin-bottom: 15px;" target="_blank">
         Ouvrir le dossier SharePoint ↗
        </a>
<label style="display: block; margin-bottom: 5px; font-weight: 500;">
         Notes :
        </label>
<textarea class="ao-textarea" placeholder="Saisissez vos notes..."></textarea>
</div>
<div class="vendor-content hidden" id="vendor-agendize">
<h3>
         Agendize
        </h3>
<a class="button add-button" href="https://sgs.sharepoint.com/sites/fr-it-insideit/serviceachats/Management%20des%20Achats/Forms/AllItems.aspx?id=%2Fsites%2Ffr%2Dit%2Dinsideit%2Fserviceachats%2FManagement%20des%20Achats%2FDocuments%20Administratifs%2FDocument%20RFP%20%5F%20IT%20SEC%20%5F%20RGPD%2FConsultations%2F2025%2FRFP%20%2D%20REFONTE%20AGENDA%20%2D%20WD%2017324%2FREPONSES%20RFP%2FAGENDIZE&amp;viewid=0d16130d%2Dc55c%2D4cb1%2D8da5%2D7e1f92f220e3&amp;CT=1751361905083&amp;OR=OWA%2DNT%2DMail&amp;CID=cd4c72fa%2D764b%2D052e%2Dac9a%2D8ad11d8aadda&amp;e=5%3Adb70ddaf8f4049279fa75a90ef3d7f42&amp;sharingv2=true&amp;fromShare=true&amp;at=9&amp;FolderCTID=0x0120008FEABFED2651E84D82FB0CFF22DD7750" style="margin-bottom: 15px;" target="_blank">
         Ouvrir le dossier SharePoint ↗
        </a>
<label style="display: block; margin-bottom: 5px; font-weight: 500;">
         Notes :
        </label>
<textarea class="ao-textarea" placeholder="Saisissez vos notes..."></textarea>
</div>
<div class="vendor-content hidden" id="vendor-itec">
<h3>
         Itec
        </h3>
<a class="button add-button" href="https://sgs.sharepoint.com/sites/fr-it-insideit/serviceachats/Management%20des%20Achats/Forms/AllItems.aspx?id=%2Fsites%2Ffr%2Dit%2Dinsideit%2Fserviceachats%2FManagement%20des%20Achats%2FDocuments%20Administratifs%2FDocument%20RFP%20%5F%20IT%20SEC%20%5F%20RGPD%2FConsultations%2F2025%2FRFP%20%2D%20REFONTE%20AGENDA%20%2D%20WD%2017324%2FREPONSES%20RFP%2FITEC&amp;viewid=0d16130d%2Dc55c%2D4cb1%2D8da5%2D7e1f92f220e3&amp;CT=1751361905083&amp;OR=OWA%2DNT%2DMail&amp;CID=cd4c72fa%2D764b%2D052e%2Dac9a%2D8ad11d8aadda&amp;e=5%3Adb70ddaf8f4049279fa75a90ef3d7f42&amp;sharingv2=true&amp;fromShare=true&amp;at=9&amp;FolderCTID=0x0120008FEABFED2651E84D82FB0CFF22DD7750" style="margin-bottom: 15px;" target="_blank">
         Ouvrir le dossier SharePoint ↗
        </a>
<label style="display: block; margin-bottom: 5px; font-weight: 500;">
         Notes :
        </label>
<textarea class="ao-textarea" placeholder="Saisissez vos notes..."></textarea>
</div>
<div class="vendor-content hidden" id="vendor-nexius">
<h3>
         Nexius
        </h3>
<a class="button add-button" href="https://sgs.sharepoint.com/sites/fr-it-insideit/serviceachats/Management%20des%20Achats/Forms/AllItems.aspx?id=%2Fsites%2Ffr%2Dit%2Dinsideit%2Fserviceachats%2FManagement%20des%20Achats%2FDocuments%20Administratifs%2FDocument%20RFP%20%5F%20IT%20SEC%20%5F%20RGPD%2FConsultations%2F2025%2FRFP%20%2D%20REFONTE%20AGENDA%20%2D%20WD%2017324%2FREPONSES%20RFP%2FNEXIUS&amp;viewid=0d16130d%2Dc55c%2D4cb1%2D8da5%2D7e1f92f220e3&amp;CT=1751361905083&amp;OR=OWA%2DNT%2DMail&amp;CID=cd4c72fa%2D764b%2D052e%2Dac9a%2D8ad11d8aadda&amp;e=5%3Adb70ddaf8f4049279fa75a90ef3d7f42&amp;sharingv2=true&amp;fromShare=true&amp;at=9&amp;FolderCTID=0x0120008FEABFED2651E84D82FB0CFF22DD7750" style="margin-bottom: 15px;" target="_blank">
         Ouvrir le dossier SharePoint ↗
        </a>
<label style="display: block; margin-bottom: 5px; font-weight: 500;">
         Notes :
        </label>
<textarea class="ao-textarea" placeholder="Saisissez vos notes..."></textarea>
</div>
<div class="vendor-content hidden" id="vendor-simplybook">
<h3>
         Simplybook
        </h3>
<a class="button add-button" href="https://sgs.sharepoint.com/sites/fr-it-insideit/serviceachats/Management%20des%20Achats/Forms/AllItems.aspx?id=%2Fsites%2Ffr%2Dit%2Dinsideit%2Fserviceachats%2FManagement%20des%20Achats%2FDocuments%20Administratifs%2FDocument%20RFP%20%5F%20IT%20SEC%20%5F%20RGPD%2FConsultations%2F2025%2FRFP%20%2D%20REFONTE%20AGENDA%20%2D%20WD%2017324%2FREPONSES%20RFP%2FSIMPLYBOOKME&amp;viewid=0d16130d%2Dc55c%2D4cb1%2D8da5%2D7e1f92f220e3&amp;CT=1751361905083&amp;OR=OWA%2DNT%2DMail&amp;CID=cd4c72fa%2D764b%2D052e%2Dac9a%2D8ad11d8aadda&amp;e=5%3Adb70ddaf8f4049279fa75a90ef3d7f42&amp;sharingv2=true&amp;fromShare=true&amp;at=9&amp;FolderCTID=0x0120008FEABFED2651E84D82FB0CFF22DD7750" style="margin-bottom: 15px;" target="_blank">
         Ouvrir le dossier SharePoint ↗
        </a>
<label style="display: block; margin-bottom: 5px; font-weight: 500;">
         Notes :
        </label>
<textarea class="ao-textarea" placeholder="Saisissez vos notes..."></textarea>
</div>
<div class="vendor-content hidden" id="vendor-microsoft">
<h3>
         Microsoft (Bookings)
        </h3>
<button class="button" disabled="" style="margin-bottom: 15px;">
         (Lien SharePoint non fourni)
        </button>
<label style="display: block; margin-bottom: 5px; font-weight: 500;">
         Notes :
        </label>
<textarea class="ao-textarea" placeholder="Saisissez vos notes..."></textarea>
</div>
</div>
</div>
<div class="sub-content-tab hidden" id="grille-evaluation">
<div class="ao-table-wrapper" style="max-height: 70vh; overflow-y: auto;">
<table class="ao-table" style="table-layout: fixed; width: 95%;">
<thead>
<tr>
<th style="width: 25%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           Critère
          </th>
<th class="text-center" style="width: 14%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           SIMPLYBOOK
          </th>
<th class="text-center" style="width: 14%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           AGENDIZE
          </th>
<th class="text-center border-l border-gray-400" style="width: 14%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           ITEC
          </th>
<th class="text-center" style="width: 14%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           NEXIUS
          </th>
<th class="text-center" style="width: 14%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           ACTENCY
          </th>
</tr>
</thead>
<tbody>
<tr class="row-total" style="background-color: var(--nord6); font-size: 1.1em;">
<td colspan="6" style="font-weight: 700; color: var(--nord0); padding-left: 5px;">
           Solution
          </td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Type de Réponse
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Solution Éditeur
           </span>
<span class="ao-tooltip-text">
            Source: Solution de planification Enterprise (p.4, p.16)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Solution Éditeur
           </span>
<span class="ao-tooltip-text">
            Source: Offre Agendize
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Dév. Spécifique
           </span>
<span class="ao-tooltip-text">
            Source: Offre technique ITEC (p.4)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Dév. Spécifique
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.4)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Dév. Spécifique
           </span>
<span class="ao-tooltip-text">
            Source: Grille Fonctionnelle Agenda – ACTENCY.xlsx
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Adéquation fonctionnelle
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Vigilance (SaaS générique, partiel)
           </span>
<span class="ao-tooltip-text">
            Source: Grille Fonctionnelle Agenda – Copie (3).xlsx (Réponses 'PARTIELLE')
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (Couverture native élevée)
           </span>
<span class="ao-tooltip-text">
            Source: Grille Fonctionnelle Agenda.csv (Réponses globales)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            À construire (Lot 2, détaillé)
           </span>
<span class="ao-tooltip-text">
            Source: Offre technique ITEC (p.10-14)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            À construire (Lot 2, très détaillé)
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.10-19)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            À construire (Lot 2, MVP+Lots)
           </span>
<span class="ao-tooltip-text">
            Source: Grille Fonctionnelle Agenda – ACTENCY.xlsx
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Qualité UX/UI proposée
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Moderne, épurée)
           </span>
<span class="ao-tooltip-text">
            Source: Solution de planification Enterprise (p.11-12)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Omnicanal)
           </span>
<span class="ao-tooltip-text">
            Source: Agendize_plaquette_generale_2025.pdf (p.1)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Mockups, ateliers)
           </span>
<span class="ao-tooltip-text">
            Source: Offre technique ITEC (p.6, p.11)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Standard (Ateliers, pas de mockups)
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.6, p.10)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (Expertise UX-PM)
           </span>
<span class="ao-tooltip-text">
            Source: Mémoire.pdf (p.2, p.38-40)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Pertinence des innovations (IA, etc.)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (AI Assistant, WhatsApp)
           </span>
<span class="ao-tooltip-text">
            Source: RFI Genilink_SGS 2025 (2).xlsx (Q25)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (Chatbots IA)
           </span>
<span class="ao-tooltip-text">
            Source: Agendize_plaquette_generale_2025.pdf (p.1)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Chatbot IA en option)
           </span>
<span class="ao-tooltip-text">
            Source: Offre technique ITEC (p.15)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (Axe majeur, IA générative)
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.6)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (Structuré, "Plateforme Agentique")
           </span>
<span class="ao-tooltip-text">
            Source: Mémoire.pdf (p.2, p.45)
           </span>
</td>
</tr>
</tbody>
<tbody>
<tr class="row-total" style="background-color: var(--nord6); font-size: 1.1em;">
<td colspan="6" style="font-weight: 700; color: var(--nord0); padding-left: 5px;">
           Technique
          </td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Respect SLA Critique (&lt; 1h Résolution)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            1h Réponse, Résolution non garantie
           </span>
<span class="ao-tooltip-text">
            Source: SBM_MSA_v.3.0. .docx.pdf (p.1 - Enterprise SLAs)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            GTR &lt; 4h
           </span>
<span class="ao-tooltip-text">
            Source: IT Security Form... - TP Evaluation.csv (Ligne 10.5)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Résolution 4h
           </span>
<span class="ao-tooltip-text">
            Source: Contrat de services ITEC (p.16 - Annexe 1)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            GTR 4h
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.20)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Résolution 4h ouvrées
           </span>
<span class="ao-tooltip-text">
            Source: Annexe 1 - Hébergement.pdf (p.16 - GTR)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Respect Disponibilité (&lt; 2h/an)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            99.9% (8.77h/an)
           </span>
<span class="ao-tooltip-text">
            Source: SBM_MSA_v.3.0. .docx.pdf (p.12 - Art 4.1)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            99.95% (4.38h/an)
           </span>
<span class="ao-tooltip-text">
            Source: _Contrat type FR (Annexe 1) &amp; IT Security Form (Ligne 10.4)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            99.9% (8.77h/an)
           </span>
<span class="ao-tooltip-text">
            Source: Contrat de services ITEC (p.16 - Annexe 1)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            99.9% (8.77h/an)
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.20)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            99.95% (4.38h/an)
           </span>
<span class="ao-tooltip-text">
            Source: Annexe 1 - Hébergement.pdf (p.13)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Architecture &amp; Sécurité
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            ISO 27001, HIPAA, PenTest
           </span>
<span class="ao-tooltip-text">
            Source: Certificate for ISO 27001...jpg &amp; SBM - Letter of Attestation (PenTest)...2024.pdf &amp; IT Security Form... - SBM Completed.xlsx (Q1.1)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            ISO 27001
           </span>
<span class="ao-tooltip-text">
            Source: Certi-Trust - Certificat ISO 27001 - AGENDIZE - SIGNED.pdf
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            ISO 27001
           </span>
<span class="ao-tooltip-text">
            Source: IT Security Form ITEC (Ligne 1.1)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Architecture Microservices
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.26)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            AWS Paris (Multi-AZ)
           </span>
<span class="ao-tooltip-text">
            Source: Annexe 1 - Hébergement.pdf (p.5, p.12)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Plan de Reprise (Continuité/Sinistre)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Robuste (RTO 72h)
           </span>
<span class="ao-tooltip-text">
            Source: SBM_Overview of_ BC_DR Plan.pdf (p.18)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Standard (BCP/DRP confirmé)
           </span>
<span class="ao-tooltip-text">
            Source: IT Security Form... - TP Evaluation.csv (Ligne 10.3)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Standard (RTO 4h, RPO 24h)
           </span>
<span class="ao-tooltip-text">
            Source: Contrat de services ITEC (p.16 - Annexe 1)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Standard (RTO 4h, RPO 24h)
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.22)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (Détaillé, RTO &lt; 2h, RPO &lt; 5min)
           </span>
<span class="ao-tooltip-text">
            Source: Annexe 1 - Hébergement.pdf (p.15 - PRA)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">Support (Portail, Niveaux, Langue)</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;"><span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">Point fort (Chat 24/5, AM dédié, SLA)</span><span class="ao-tooltip-text">Source: Master Service Agreement (Annexe 2 - SLA)</span></td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;"><span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">Point fort (Multi-canal 8-18h, GTR 4h)</span><span class="ao-tooltip-text">Source: Réponse Agendize (Accompagnement)</span></td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;"><span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">Bon (Tél/Email 9-18h, SLA contractuels)</span><span class="ao-tooltip-text">Source: Contrat Type (Art 4. SUPPORT) &amp; Offre Technique</span></td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;"><span style="font-size: 0.9em; word-wrap: break-word; white-space: normal; color: var(--grey);">À compléter...</span><span class="ao-tooltip-text">Source: À compléter...</span></td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;"><span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">Bon (GLPI 9-18h, SLA contractuels)</span><span class="ao-tooltip-text">Source: Mémoire.pdf (Sect 4.3 - Support)</span></td>
</tr>
</tbody>
<tbody>
<tr class="row-total" style="background-color: var(--nord6); font-size: 1.1em;">
<td colspan="6" style="font-weight: 700; color: var(--nord0); padding-left: 5px;">
           Projet
          </td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Engagement livraison Fin 2026
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            N/A (SaaS Lot 1)
           </span>
<span class="ao-tooltip-text">
            Source: Solution SaaS existante. Pas un projet de dév. long, mais un "Setup rapide" de 10k€. (Source: Solution de planification Enterprise, p.16)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Go (Fin 2026)
           </span>
<span class="ao-tooltip-text">
            Source: L'offre inclut une phase de "Build" (dév. spécifiques, intégrations) de 280k€. (Source: Modèle économique, p.3)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Go (Fin 2026)
           </span>
<span class="ao-tooltip-text">
            Source: Point fort (Oct 2026) - Offre technique ITEC (p.23 - Planning)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Go (Fin 2026)
           </span>
<span class="ao-tooltip-text">
            Source: Point fort (MEP 12ème mois) - Offre Technique NEXIUS (p.23)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Go (Fin 2026)
           </span>
<span class="ao-tooltip-text">
            Source: Point fort (V1 12ème mois) - Mémoire.pdf (p.74 - Macro-planning)
           </span>
</td>
</tr>
</tbody>
<tbody>
<tr class="row-total" style="background-color: var(--nord6); font-size: 1.1em;">
<td colspan="6" style="font-weight: 700; color: var(--nord0); padding-left: 5px;">
           Conformité
          </td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Respect Cession / Exclusivité
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            N/A (Lot 1)
           </span>
<span class="ao-tooltip-text">
            Source: Grille RFP
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Go (Lot 1 - Exclusivité dev.)
           </span>
<span class="ao-tooltip-text">
            Source: Info RFP (non présent ds les docs)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Go (Cession sources Lot 2)
           </span>
<span class="ao-tooltip-text">
            Source: Contrat de services ITEC (p.10 - Art 16.2)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Go (Cession sources Lot 2)
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.21)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Go (Cession sources Lot 2)
           </span>
<span class="ao-tooltip-text">
            Source: Mémoire.pdf (p.15 - Propriété intellectuelle)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Qualité réponse RGPD
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (DPO, UE)
           </span>
<span class="ao-tooltip-text">
            Source: RGPD_FR- SGS France - Questionnaire (2).xlsx (Q2)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Q° détaillé, DPO)
           </span>
<span class="ao-tooltip-text">
            Source: IT Security Form... - TP Evaluation.csv (Lignes 8.1, 8.3)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Conforme, DPO)
           </span>
<span class="ao-tooltip-text">
            Source: Questionnaire RGPD ITEC (Q2, Q3)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Conforme, DPO, France)
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.26)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (DPO, AWS Paris, Q° détaillé)
           </span>
<span class="ao-tooltip-text">
            Source: Questionnaire RGPD.csv (Q2, Q25)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Qualité réponse RSE (Green IT)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (UN Global Compact, B Corp)
           </span>
<span class="ao-tooltip-text">
            Source: team.blue_impact_report_25 (1).pdf (p.36)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Signataire Code SGS)
           </span>
<span class="ao-tooltip-text">
            Source: Agendize_Politique environnementale_V25.09.pdf
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (Égalité F/H 92%, Éco-conception)
           </span>
<span class="ao-tooltip-text">
            Source: RFI Genilink_SGS - ITEC (Q24)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Point fort (EcoVadis Silver 2024)
           </span>
<span class="ao-tooltip-text">
            Source: Présentation Nexius Group 2025.pdf (p.4)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Bonne (Signataire Code SGS, Éco-conception)
           </span>
<span class="ao-tooltip-text">
            Source: SGS Code de Conduite Fournisseur - Signed (1).pdf
           </span>
</td>
</tr>
</tbody>
<tbody>
<tr class="row-total" style="background-color: var(--nord6); font-size: 1.1em;">
<td colspan="6" style="font-weight: 700; color: var(--nord0); padding-left: 5px;">
           Coûts
          </td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Coût Projet (Build / Setup)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            10 000 €
           </span>
<span class="ao-tooltip-text">
            Source: Solution de planification Enterprise (p.16)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            279 650 €
           </span>
<span class="ao-tooltip-text">
            Source: Modèle économique Agendize pour le Groupe SGS.pdf (p.3)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            368 545 €
           </span>
<span class="ao-tooltip-text">
            Source: Offre financière ITEC (p.3)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            693 000 € (incl. 1 an TMA/Run)
           </span>
<span class="ao-tooltip-text">
            Source: Offre financière NEXIUS (p.7)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            379 171 €
           </span>
<span class="ao-tooltip-text">
            Source: Annexe 2 - synthèse budgétaire.pdf (p.13)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Coût Récurrent (Run Annuel stable, post-A1)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            272 220 €
           </span>
<span class="ao-tooltip-text">
            Source: Solution de planification Enterprise (p.16 - Prix 2e année)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            299 400 €
           </span>
<span class="ao-tooltip-text">
            Source: Modèle économique Agendize pour le Groupe SGS.pdf (p.4)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            274 190 €
           </span>
<span class="ao-tooltip-text">
            Source: Offre financière ITEC (p.3)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            111 600 €
           </span>
<span class="ao-tooltip-text">
            Source: Offre financière NEXIUS (p.7)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            79 505 €
           </span>
<span class="ao-tooltip-text">
            Source: Annexe 2 - synthèse budgétaire.pdf (p.14)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Coût Total 3 ans (Build + 3xRun ou équiv.)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            946 660 €
           </span>
<span class="ao-tooltip-text">
            Source: Calcul (Y1 402k€ incl. Build + 2xRun 272k€) - Solution de planification (p.16)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            1 177 850 €
           </span>
<span class="ao-tooltip-text">
            Source: Calcul (Build 279k€ + 3*Run 299k€) - Modèle économique p.3-4
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            1 191 115 €
           </span>
<span class="ao-tooltip-text">
            Source: Calcul (Build 368k€ + 3*Run 274k€) - Offre financière (p.3)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            916 200 €
           </span>
<span class="ao-tooltip-text">
            Source: Calcul (Build 693k€ incl. A1 + 2*Run 111.6k€) - Offre financière (p.7)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            617 686 €
           </span>
<span class="ao-tooltip-text">
            Source: Calcul (Build 379k€ + 3*Run 79.5k€)
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Risque Contractuel (Droit applicable)
          </td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Majeur (Droit Chypre, Tribunal Limassol)
           </span>
<span class="ao-tooltip-text">
            Source: SBM_MSA_v.3.0. .docx.pdf (p.29 - Art 12.11, 12.12)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Faible (Droit Français)
           </span>
<span class="ao-tooltip-text">
            Source: _Contrat type FR 26 avril 2024.docx (p.1)
           </span>
</td>
<td class="ao-tooltip-container border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Faible (Droit Français)
           </span>
<span class="ao-tooltip-text">
            Source: Contrat de services ITEC (p.13 - Art 24)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Faible (Droit Français)
           </span>
<span class="ao-tooltip-text">
            Source: Offre Technique NEXIUS (p.27)
           </span>
</td>
<td class="ao-tooltip-container" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            Faible (Droit Français)
           </span>
<span class="ao-tooltip-text">
            Source: 2025_10_16 Extrait KBIS - ACTENCY.pdf
           </span>
</td>
</tr>
</tbody>
<tbody>
<tr class="row-total" style="background-color: var(--nord6); font-size: 1.1em;">
<td colspan="6" style="font-weight: 700; color: var(--nord0); padding-left: 5px;">
           Notation
          </td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Note Adéquation (Solution Éditeur)
          </td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★
            </span>
<span style="color: var(--nord4);">
             ☆☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Adéquation fonctionnelle partielle, grille indique 'Vigilance'.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★
            </span>
<span style="color: var(--nord4);">
             ☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Couverture fonctionnelle native très élevée ('Point Fort').
           </span>
</td>
<td class="text-center border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; color: var(--grey);">
            N/A
           </span>
</td>
<td class="text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; color: var(--grey);">
            N/A
           </span>
</td>
<td class="text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; color: var(--grey);">
            N/A
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Note Adéquation (Dév. Spécifique)
          </td>
<td class="text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; color: var(--grey);">
            N/A
           </span>
</td>
<td class="text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; color: var(--grey);">
            N/A
           </span>
</td>
<td class="ao-tooltip-container text-center border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★
            </span>
<span style="color: var(--nord4);">
             ☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Réponse standard 'À construire', semble complète.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★
            </span>
<span style="color: var(--nord4);">
             ☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Réponse 'très détaillée', ce qui est un bon point.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★
            </span>
<span style="color: var(--nord4);">
             ☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Approche projet (MVP+Lots) claire et structurée.
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Note Technique &amp; Sécurité
          </td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★
            </span>
<span style="color: var(--nord4);">
             ☆☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Points forts sur ISO 27001/PenTest, mais SLA hors cible (Dispo 99.9% et GTR) et RTO très long (72h).
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★
            </span>
<span style="color: var(--nord4);">
             ☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: ISO 27001 et Dispo 99.95%, mais GTR hors cible (&lt;4h) et RTO/RPO standard.
           </span>
</td>
<td class="ao-tooltip-container text-center border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★
            </span>
<span style="color: var(--nord4);">
             ☆☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: ISO 27001, mais SLA hors cible (Dispo 99.9% et GTR 4h).
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★
            </span>
<span style="color: var(--nord4);">
             ☆☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Architecture Microservices, mais SLA hors cible (Dispo 99.9% et GTR 4h).
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★
            </span>
<span style="color: var(--nord4);">
             ☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Meilleure offre technique : Dispo 99.95%, RTO/RPO excellent (&lt;2h, &lt;5min), AWS Paris.
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Note Pilotage Projet &amp; RSE
          </td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★
            </span>
<span style="color: var(--nord4);">
             ☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: RSE 'Point Fort' (B Corp). Livraison N/A car setup SaaS.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★
            </span>
<span style="color: var(--nord4);">
             ☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Engagement clair sur le planning (phase Build) et RSE 'Bonne'.
           </span>
</td>
<td class="ao-tooltip-container text-center border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★★
            </span>
<span style="color: var(--nord4);">
</span>
</span>
<span class="ao-tooltip-text">
            Source: RSE 'Point Fort' et engagement clair sur le planning.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★★
            </span>
<span style="color: var(--nord4);">
</span>
</span>
<span class="ao-tooltip-text">
            Source: RSE 'Point Fort' (EcoVadis) et engagement clair sur le planning.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★
            </span>
<span style="color: var(--nord4);">
             ☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Engagement clair sur le planning et RSE 'Bonne'.
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           Note Coûts &amp; Risques
          </td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★
            </span>
<span style="color: var(--nord4);">
             ☆☆☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Risque contractuel 'Majeur' (Droit Chypre) et coût total élevé (947k€).
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★
            </span>
<span style="color: var(--nord4);">
             ☆☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Coût total très élevé (1.18M€), mais risque légal faible.
           </span>
</td>
<td class="ao-tooltip-container text-center border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★
            </span>
<span style="color: var(--nord4);">
             ☆☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Coût total le plus élevé (1.19M€), mais risque légal faible.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★
            </span>
<span style="color: var(--nord4);">
             ☆☆
            </span>
</span>
<span class="ao-tooltip-text">
            Source: Coût total élevé (916k€), mais risque légal faible.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 1.2em; letter-spacing: 1px;">
<span style="color: var(--nord10);">
             ★★★★★
            </span>
<span style="color: var(--nord4);">
</span>
</span>
<span class="ao-tooltip-text">
            Source: Meilleure offre : Coût total le plus bas (618k€) et risque légal faible.
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 25%; word-wrap: break-word;">
           NOTE GLOBALE (CALCULÉE)
          </td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            2/5
           </span>
<span class="ao-tooltip-text">
            Moyenne arithmétique des 4 notes de la Section 6.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            3/5
           </span>
<span class="ao-tooltip-text">
            Moyenne arithmétique des 4 notes de la Section 6.
           </span>
</td>
<td class="ao-tooltip-container text-center border-l border-gray-400" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            3/5
           </span>
<span class="ao-tooltip-text">
            Moyenne arithmétique des 4 notes de la Section 6.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            4/5
           </span>
<span class="ao-tooltip-text">
            Moyenne arithmétique des 4 notes de la Section 6.
           </span>
</td>
<td class="ao-tooltip-container text-center" style="width: 14%; vertical-align: middle; word-wrap: break-word;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            4/5
           </span>
<span class="ao-tooltip-text">
            Moyenne arithmétique des 4 notes de la Section 6.
           </span>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sub-content-tab hidden" id="synthese-podium">
<h3 class="ao-section-card-header" style="font-size: 1.5em; margin-top: 10px;">
       Podium (Basé sur le Coût Total 3 ans)
      </h3>
<div class="ao-podium-container">
<div class="ao-podium-step bronze">
<div class="ao-podium-rank">
         3
        </div>
<div class="ao-podium-name">
         SIMPLYBOOK
        </div>
<div class="ao-podium-score">
         946 660 €
        </div>
</div>
<div class="ao-podium-step unranked">
<div class="ao-podium-rank"> 4 </div>
<div class="ao-podium-name">
         AGENDIZE
        </div>
<div class="ao-podium-score unranked-text-eval">
         1 177 850 €
        </div>
</div>
<div class="ao-podium-step unranked">
<div class="ao-podium-rank"> 4 </div>
<div class="ao-podium-name">
         ITEC
        </div>
<div class="ao-podium-score unranked-text-eval">
         1 191 115 €
        </div>
</div>
<div class="ao-podium-step silver">
<div class="ao-podium-rank">
         2
        </div>
<div class="ao-podium-name">
         NEXIUS
        </div>
<div class="ao-podium-score">
         916 200 €
        </div>
</div>
<div class="ao-podium-step gold">
<div class="ao-podium-rank">
         1
        </div>
<div class="ao-podium-name">
         ACTENCY
        </div>
<div class="ao-podium-score">
         617 686 €
        </div>
</div>
</div><h3 class="ao-section-card-header" style="font-size: 1.5em; margin-top: 40px;">Podium (Basé sur la Note Globale)</h3><div class="ao-podium-container"><div class="ao-podium-step gold" style="height: 100%;"><div class="ao-podium-rank">1</div><div class="ao-podium-name">NEXIUS</div><div class="ao-podium-score">4/5</div></div><div class="ao-podium-step gold" style="height: 100%;"><div class="ao-podium-rank">1</div><div class="ao-podium-name">ACTENCY</div><div class="ao-podium-score">4/5</div></div><div class="ao-podium-step bronze" style="height: 60%;"><div class="ao-podium-rank">3</div><div class="ao-podium-name">AGENDIZE</div><div class="ao-podium-score">3/5</div></div><div class="ao-podium-step bronze" style="height: 60%;"><div class="ao-podium-rank">3</div><div class="ao-podium-name">ITEC</div><div class="ao-podium-score">3/5</div></div><div class="ao-podium-step unranked" style="height: 40%;"><div class="ao-podium-rank">5</div><div class="ao-podium-name">SIMPLYBOOK</div><div class="ao-podium-score">2/5</div></div></div>
<h3 class="ao-section-card-header" style="font-size: 1.5em; margin-top: 40px;">
       Synthèse des Points Clés
      </h3>
<div class="ao-table-wrapper" style="margin-top: 20px">
<table class="ao-table" style="table-layout: fixed; width: 95%;">
<thead>
<tr>
<th style="width: 20%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           Fournisseur
          </th>
<th style="width: 35%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           Points Forts
          </th>
<th style="width: 35%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           Points de Vigilance
          </th>
<th class="text-center" style="width: 10%; position: sticky; top: 0; z-index: 10; background-color: var(--nord6);">
           Note Globale
          </th>
</tr>
</thead>
<tbody>
<tr>
<td class="col-critere" style="width: 20%; word-wrap: break-word;">
           SIMPLYBOOK
          </td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Note Pilotage Projet &amp; RSE
            </li>
<li>
             Qualité réponse RSE (Green IT)
            </li>
<li>
             Pertinence des innovations (IA, etc.)
            </li>
<li>
             Qualité UX/UI proposée
            </li>
<li>
             Qualité réponse RGPD
            </li>
</ul>
</td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Respect SLA Critique (&lt; 1h Résolution)
            </li>
<li>
             Respect Disponibilité (&lt; 2h/an)
            </li>
<li>
             Adéquation fonctionnelle
            </li>
</ul>
</td>
<td class="text-center" style="vertical-align: middle;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            2/5
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 20%; word-wrap: break-word;">
           AGENDIZE
          </td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Note Pilotage Projet &amp; RSE
            </li>
<li>
             Qualité réponse RSE (Green IT)
            </li>
<li>
             Pertinence des innovations (IA, etc.)
            </li>
<li>
             Qualité UX/UI proposée
            </li>
<li>
             Qualité réponse RGPD
            </li>
<li>
             Adéquation fonctionnelle
            </li>
<li>
             Note Adéquation (Solution Éditeur)
            </li>
</ul>
</td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Respect Disponibilité (&lt; 2h/an)
            </li>
</ul>
</td>
<td class="text-center" style="vertical-align: middle;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            3/5
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 20%; word-wrap: break-word;">
           ITEC
          </td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Note Pilotage Projet &amp; RSE
            </li>
<li>
             Qualité réponse RSE (Green IT)
            </li>
<li>
             Pertinence des innovations (IA, etc.)
            </li>
<li>
             Engagement livraison Fin 2026
            </li>
<li>
             Qualité UX/UI proposée
            </li>
<li>
             Qualité réponse RGPD
            </li>
</ul>
</td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Respect SLA Critique (&lt; 1h Résolution)
            </li>
<li>
             Respect Disponibilité (&lt; 2h/an)
            </li>
</ul>
</td>
<td class="text-center" style="vertical-align: middle;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            3/5
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 20%; word-wrap: break-word;">
           NEXIUS
          </td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Note Pilotage Projet &amp; RSE
            </li>
<li>
             Qualité réponse RSE (Green IT)
            </li>
<li>
             Pertinence des innovations (IA, etc.)
            </li>
<li>
             Engagement livraison Fin 2026
            </li>
<li>
             Qualité réponse RGPD
            </li>
</ul>
</td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Respect Disponibilité (&lt; 2h/an)
            </li>
</ul>
</td>
<td class="text-center" style="vertical-align: middle;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            4/5
           </span>
</td>
</tr>
<tr>
<td class="col-critere" style="width: 20%; word-wrap: break-word;">
           ACTENCY
          </td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Note Pilotage Projet &amp; RSE
            </li>
<li>
             Qualité réponse RSE (Green IT)
            </li>
<li>
             Pertinence des innovations (IA, etc.)
            </li>
<li>
             Engagement livraison Fin 2026
            </li>
<li>
             Qualité UX/UI proposée
            </li>
<li>
             Qualité réponse RGPD
            </li>
<li>
             Plan de Reprise (Continuité/Sinistre)
            </li>
</ul>
</td>
<td style="vertical-align: top; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;">
<ul>
<li>
             Respect SLA Critique (&lt; 1h Résolution)
            </li>
<li>
             Respect Disponibilité (&lt; 2h/an)
            </li>
</ul>
</td>
<td class="text-center" style="vertical-align: middle;">
<span style="font-size: 0.9em; word-wrap: break-word; white-space: normal;">
            4/5
           </span>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="static-mindmap-container content-tab hidden" id="static-mindmap-container">
<h2>
      🖼️ Carte Statique
     </h2>
<img alt="Carte Mentale du Projet" src="Map.png" style="width: 100%; height: auto; border-radius: 8px;"/>
</div>
<div class="admin-container content-tab hidden" id="documentation-container" style="line-height: 1.6;">
<h2>
      📚 Documentation de l'outil de priorisation Neo-CT
     </h2>
<h3>
      Objectif de l'application
     </h3>
<p>
      Cette application (SPA - Single Page Application) a été conçue pour centraliser, structurer et prioriser
                    l'ensemble des développements prévus pour le projet Neo-CT. Elle remplace les fichiers Excel statiques
                    par une interface web dynamique, collaborative et connectée à une base de données en temps réel (Firestore).
     </p>
<h3>
      Ce qu'elle propose : les fonctionnalités clés
     </h3>
<ul>
<li>
<b>
        Gestion centralisée :
       </b>
       Ajouter, modifier et supprimer les "Applis" (briques logicielles),
                        les "Modules" (fonctionnalités majeures) et les "Fonctionnalités" (sous-tâches ou user stories détaillées).
      </li>
<li>
<b>
        Priorisation visuelle (Drag &amp; Drop) :
       </b>
       L'onglet "Priorisation" offre une vue Kanban (P1, P2, P3, À définir)
                        où les modules peuvent être glissés-déposés pour définir leur priorité.
      </li>
<li>
<b>
        Actions groupées :
       </b>
       Cocher plusieurs modules dans l'onglet "Gestion" pour leur appliquer des étiquettes
                        en masse ou les déplacer vers une autre appli.
      </li>
<li>
<b>
        Vues d'analyse :
       </b>
<ul>
<li>
<b>
          Tableau de bord :
         </b>
         KPIs et graphiques sur la répartition des tâches.
        </li>
<li>
<b>
          Vue MVP (P1) :
         </b>
         Un focus immédiat sur tous les modules P1, triés par appli et étiquette.
        </li>
<li>
<b>
          Cartes (Mindmaps) :
         </b>
         Vues hiérarchiques pour comprendre la structure du projet (par appli ou par priorité).
        </li>
<li>
<b>
          Niveau de Détail :
         </b>
         Analyse de la granularité et de la description des modules.
        </li>
</ul>
</li>
<li>
<b>
        Administration :
       </b>
       Gérer la liste des étiquettes et des priorités disponibles, et exporter toutes les données.
      </li>
</ul>
<h3>
      Comment elle fonctionne ? (Techniquement)
     </h3>
<p>
      Tout est contenu dans un seul fichier
      <code>
       index.html
      </code>
      . L'application utilise :
     </p>
<ul>
<li>
<b>
        Firebase (Firestore) :
       </b>
       Pour la base de données. Chaque action (ajout, modification, glisser-déposer)
                        est synchronisée en temps réel avec la base.
      </li>
<li>
<b>
        Chart.js :
       </b>
       Pour les graphiques du tableau de bord.
      </li>
<li>
<b>
        Sortable.js :
       </b>
       Pour toutes les fonctionnalités de glisser-déposer.
      </li>
<li>
<b>
        Marked.js :
       </b>
       Pour afficher les descriptions des fonctionnalités (qui peuvent être écrites en Markdown).
      </li>
</ul>
</div>
</div>
</div>
<div id="kpi-tooltip-container">
</div>
<div id="reorg-tooltip-container">
</div>
<div class="modal-overlay hidden" id="project-modal">
<div class="modal-content">
<h3 id="project-modal-title">
     Ajouter une appli
    </h3>
<form data-existing-features="[]" id="project-form">
<input id="project-id" type="hidden"/>
<div>
<label for="project-name">
       Nom de l'appli
      </label>
<input id="project-name" required="" type="text"/>
</div>
<div>
<label for="project-description">
       Description de l'appli
      </label>
<textarea id="project-description" rows="3"></textarea>
</div>
<div id="features-section">
<h4>
       Ajouter des modules (optionnel)
      </h4>
<div class="feature-inputs">
<input id="feature-name" placeholder="Nom du nouveau module" type="text"/>
<button class="button add-button" id="add-feature-btn" type="button">
        Ajouter
       </button>
</div>
</div>
<div class="modal-actions">
<button class="button save-button" type="submit">
       Sauvegarder
      </button>
<button class="button cancel-button" id="cancel-project-btn" type="button">
       Annuler
      </button>
</div>
</form>
</div>
</div>
<div class="modal-overlay hidden" id="quick-feature-modal">
<div class="modal-content">
<h3 id="quick-feature-modal-title">
     Ajout rapide de modules
    </h3>
<form id="quick-feature-form">
<input id="quick-feature-modal-brick-id" type="hidden"/>
<div>
<label for="quick-feature-names">
       Noms des modules (un par ligne)
      </label>
<textarea id="quick-feature-names" placeholder="Module A
Module B
Module C" required="" rows="8"></textarea>
</div>
<div>
<label for="quick-feature-priority">
       Priorité pour ce lot
      </label>
<select id="quick-feature-priority">
</select>
</div>
<div class="modal-actions">
<button class="button save-button" type="submit">
       Ajouter les modules
      </button>
<button class="button cancel-button" id="cancel-quick-feature-btn" type="button">
       Annuler
      </button>
</div>
</form>
</div>
</div>
<div class="modal-overlay hidden" id="confirm-modal">
<div class="modal-content">
<h3 id="confirm-modal-title">
     Confirmation
    </h3>
<p id="confirm-modal-body">
     Êtes-vous sûr ?
    </p>
<div class="modal-actions">
<button class="button cancel-button" id="cancel-confirm-btn">
      Annuler
     </button>
<button class="button delete-button" id="confirm-btn">
      Confirmer
     </button>
</div>
</div>
</div>
<div class="modal-overlay hidden" id="edit-feature-modal">
<div class="modal-content">
<h3 id="edit-feature-modal-title">
     Modifier le module
    </h3>
<form id="edit-feature-form">
<input accept=".json" class="hidden" id="sub-feature-json-import" type="file"/>
<div class="hidden" id="edit-feature-brick-selector-group">
<label for="edit-feature-brick-select">
       Appli parente
      </label>
<select id="edit-feature-brick-select" required="">
</select>
</div>
<div>
<label for="edit-feature-name">
       Nom du module
      </label>
<input id="edit-feature-name" required="" type="text"/>
</div>
<div>
<label for="edit-feature-priority">
       Priorité
      </label>
<select id="edit-feature-priority">
</select>
</div>
<div>
<label>
       Étiquettes
      </label>
<div class="tags-container-modal-edit" id="edit-feature-tags-container">
</div>
<div class="tags-editor">
<select class="tag-select" id="edit-feature-tag-select">
</select>
<button class="add-tag-btn" id="edit-feature-add-new-tag-btn" title="Créer une nouvelle étiquette" type="button">
        +
       </button>
</div>
</div>
<div id="sub-features-section-modal">
<h4>
       Fonctionnalités
      </h4>
<ul id="edit-sub-features-list">
</ul>
<div class="feature-inputs" style="flex-direction: column; align-items: stretch; gap: 5px;">
<input id="sub-feature-name" placeholder="Nom de la fonctionnalité" type="text"/>
<textarea id="sub-feature-description" placeholder="Description (optionnel)" rows="3"></textarea>
</div>
<div id="sub-feature-actions-container" style="text-align: right; margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
<button class="button add-button" id="import-sub-features-btn" style="background-color: var(--nord13); color: var(--nord0);" type="button">
        Importer JSON
       </button>
<button class="button add-button" id="add-sub-feature-btn" type="button">
        Ajouter
       </button>
</div>
</div>
<div class="modal-actions">
<button class="button delete-button" id="delete-feature-btn-modal" type="button">
       Supprimer
      </button>
<button class="button save-button" type="submit">
       Sauvegarder
      </button>
<button class="button cancel-button" id="cancel-edit-feature-modal-btn" type="button">
       Annuler
      </button>
</div>
</form>
</div>
</div>
<div class="modal-overlay hidden" id="sub-features-view-modal">
<div class="modal-content">
<h3 id="sub-features-view-modal-title">
     Fonctionnalités
    </h3>
<div id="sub-features-view-modal-content">
</div>
<div class="modal-actions">
<button class="button cancel-button" id="cancel-sub-features-view-btn" type="button">
      Fermer
     </button>
</div>
</div>
</div>
<div class="modal-overlay hidden" id="info-modal">
<div class="modal-content">
<h3 id="info-modal-title">
</h3>
<p id="info-modal-body" style="white-space: pre-wrap;">
</p>
<div class="modal-actions">
<button class="button cancel-button" id="cancel-info-btn">
      Fermer
     </button>
</div>
</div>
</div>
<div class="modal-overlay hidden" id="admin-edit-modal">
<div class="modal-content">
<h3 id="admin-edit-modal-title">
     Modifier l'élément
    </h3>
<form id="admin-edit-form">
<div>
<label for="admin-edit-name">
       Nom de l'élément
      </label>
<input id="admin-edit-name" required="" type="text"/>
</div>
<div class="modal-actions">
<button class="button save-button" type="submit">
       Sauvegarder
      </button>
<button class="button cancel-button" id="cancel-admin-edit-btn" type="button">
       Annuler
      </button>
</div>
</form>
</div>
</div>
<div class="modal-overlay hidden" id="bulk-tags-modal">
<div class="modal-content">
<h3 id="bulk-tags-modal-title">
     Gérer les étiquettes
    </h3>
<p>
     Appliquez une ou plusieurs étiquettes aux modules sélectionnés.
    </p>
<form id="bulk-tags-form">
<div>
<label>
       Étiquettes à appliquer
      </label>
<div class="tags-editor">
<select class="tag-select" id="bulk-tags-select">
</select>
<button class="add-tag-btn" id="bulk-add-new-tag-btn" title="Créer une nouvelle étiquette" type="button">
        +
       </button>
</div>
<div class="tags-container-modal-edit" id="bulk-tags-container">
</div>
</div>
<div class="modal-actions">
<button class="button save-button" type="submit">
       Appliquer
      </button>
<button class="button cancel-button" id="cancel-bulk-tags-btn" type="button">
       Annuler
      </button>
</div>
</form>
</div>
</div>
<div class="modal-overlay hidden" id="bulk-move-modal">
<div class="modal-content">
<h3 id="bulk-move-modal-title">
     Déplacer les modules
    </h3>
<p>
     Sélectionnez la nouvelle appli pour les modules sélectionnés.
    </p>
<form id="bulk-move-form">
<div>
<label for="bulk-move-brick-select">
       Nouvelle appli
      </label>
<select id="bulk-move-brick-select" required="">
</select>
</div>
<div class="modal-actions">
<button class="button save-button" type="submit">
       Déplacer
      </button>
<button class="button cancel-button" id="cancel-bulk-move-btn" type="button">
       Annuler
      </button>
</div>
</form>
</div>
</div>
<div class="hidden" id="bulk-action-bar">
<span id="bulk-selection-counter">
    0 sélectionné(s)
   </span>
<button class="button add-button" id="bulk-manage-tags-btn">
    Gérer les étiquettes
   </button>
<button class="button add-button" id="bulk-move-btn">
    Déplacer
   </button>
</div>
<div id="toast-notification">
   Message
  </div>
<datalist id="tag-suggestions">
</datalist>
<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, writeBatch, setDoc, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlHJGNPmw5KBVtP6TOwImmcs5YwoopiYs",
            authDomain: "neo-ct-bd4c4.firebaseapp.com",
            projectId: "neo-ct-bd4c4",
            storageBucket: "neo-ct-bd4c4.appspot.com",
            messagingSenderId: "877177713771",
            appId: "1:877177713771:web:763e78e3211771f2ab2d2e",
            measurementId: "G-Q4WRLB2MT7"
        };

        
            // ##### FONCTIONS D'EXPORT AJOUTÉES (Version 4, sans backticks) #####
            const downloadFile = (content, fileName, contentType) => {
                const a = document.createElement("a");
                const file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            };

            const exportToJSON = (data) => {
                const jsonData = JSON.stringify(data, null, 2);
                downloadFile(jsonData, 'neo-ct-export.json', 'application/json;charset=utf-8;');
            };

            const exportToCSV = (data) => {
                const escapeCSV = (str) => {
                    const s = (str || '').toString();
                    const escaped = s.replace(/"/g, '""');
                    return '"' + escaped + '"';
                };
                const headers = ['Appli_Nom', 'Module_Nom', 'Module_Priorite', 'Module_Tags', 'Nombre_Fonctionnalites'];
                let csvRows = [headers.join(',')];

                data.forEach(appli => {
                    (appli.features || []).forEach(module => {
                        const tags = (module.tags || []).join(' | ');
                        const subFeatureCount = (module.subFeatures || []).length;
                        const row = [
                            appli.name,
                            module.name,
                            module.priority || 'À définir',
                            tags,
                            subFeatureCount.toString()
                        ];
                        csvRows.push(row.map(escapeCSV).join(','));
                    });
                });
                
                const csvString = csvRows.join('\r\n');
                downloadFile(csvString, 'neo-ct-export-modules.csv', 'text/csv;charset=utf-8;');
            };
            // ##### FIN FONCTIONS D'EXPORT #####


            window.onload = async () => {

            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const step4 = document.getElementById('step4');
            const loaderContainer = document.getElementById('loader-container');
            const tableWrapper = document.getElementById('table-wrapper');
            const buttonGroupWrapper = document.getElementById('button-group-wrapper');
            const dbStatusIndicator = document.getElementById('db-status-indicator');
            let db;

            try {
                step1.classList.add('active');
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                step1.classList.remove('active');
                step1.classList.add('success');
                dbStatusIndicator.classList.add('status-ok');
                dbStatusIndicator.title = 'Connecté à la base de données';


            } catch (e) {
                console.error("Erreur de connexion Firebase", e);
                step1.classList.remove('active');
                step1.classList.add('error');
                dbStatusIndicator.classList.add('status-error');
                dbStatusIndicator.title = 'Erreur de connexion à la base de données';
                loaderContainer.innerHTML = `<strong>Erreur critique:</strong> Impossible de se connecter à la base de données.`;
                loaderContainer.classList.add('error-message');
                return;
            }

            // --- Étape 2: Initialisation des modules & Paramètres ---
            step2.classList.add('active');

            const appState = {
                currentTasks: [],
                priorities: [],
                tags: [],
                mvpFilter: 'all',

                // Filtres "Gestion"
                featureFilterPlanning: '',
                selectedBricksPlanning: [],
                selectedTagsPlanning: [],
                selectedModulesPlanning: [],

                // Filtres "Priorisation"
                featureFilterDnd: '',
                selectedBricksDnd: [],
                selectedTagsDnd: [],
                selectedModulesDnd: [],

                // Filtres "Réorganisation"
                featureFilterReorg: '',
                selectedBricksReorg: [],
                selectedTagsReorg: [],
                selectedModulesReorg: [],

                selectedFeatures: [], // Sélection de masse
                filterDebounceTimer: null,
                dndViewMode: 'features',
                charts: {},
                dashboardBrickChartFilter: 'P1',
            };

            let currentFeatures = [];
            let currentEditingFeature = { brickId: null, featureIndex: -1, tags: [], subFeatures: [] };
            let currentSubFeatureEditIndex = null;
            let currentBulkTags = [];
            let currentAdminEditing = { type: null, originalName: null };

            const elements = {
                projectModal: document.getElementById('project-modal'),
                projectModalTitle: document.getElementById('project-modal-title'),
                projectForm: document.getElementById('project-form'),
                quickFeatureModal: document.getElementById('quick-feature-modal'),
                quickFeatureForm: document.getElementById('quick-feature-form'),
                editFeatureModal: document.getElementById('edit-feature-modal'),
                editFeatureForm: document.getElementById('edit-feature-form'),
                bulkTagsModal: document.getElementById('bulk-tags-modal'),
                bulkTagsForm: document.getElementById('bulk-tags-form'),
                bulkMoveModal: document.getElementById('bulk-move-modal'),
                bulkMoveForm: document.getElementById('bulk-move-form'),
                adminEditModal: document.getElementById('admin-edit-modal'),
                adminEditForm: document.getElementById('admin-edit-form'),
                confirmModal: document.getElementById('confirm-modal'),
                addFeatureBtn: document.getElementById('add-feature-btn'),
                toast: document.getElementById('toast-notification'),
                bulkActionBar: document.getElementById('bulk-action-bar'),
                bulkSelectionCounter: document.getElementById('bulk-selection-counter'),
            };

            const parseMarkdown = (text) => {
                if (!text) return '';
                marked.setOptions({ breaks: true });
                return marked.parse(text);
            };

            const showToast = (message, type = 'success') => {
                elements.toast.textContent = message;
                elements.toast.style.backgroundColor = type === 'error' ? 'var(--nord11)' : 'var(--nord14)';
                elements.toast.classList.add('show');
                setTimeout(() => {
                    elements.toast.classList.remove('show');
                }, 4000);
            };

            const showConfirmModal = (title, body) => {
                const confirmModal = document.getElementById('confirm-modal');
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-body').textContent = body;
                confirmModal.classList.remove('hidden');

                return new Promise((resolve) => {
                    document.getElementById('confirm-btn').onclick = () => {
                        confirmModal.classList.add('hidden');
                        resolve(true);
                    };
                    document.getElementById('cancel-confirm-btn').onclick = () => {
                        confirmModal.classList.add('hidden');
                        resolve(false);
                    };
                });
            };

            // ##### FONCTION switchTab MODIFIÉE #####
            const switchTab = (targetId) => {
                document.querySelectorAll('.tab-link').forEach(item => {
                    item.classList.toggle('active', item.dataset.tab === targetId);
                });
                document.querySelectorAll('.content-tab').forEach(content => {
                    content.classList.toggle('hidden', content.id !== targetId);
                });

                // Appeler la fonction de rendu correspondante
                if (targetId === 'accueil-container') renderDashboard();
                if (targetId === 'mvp-container') renderMvpView();
                if (targetId === 'dnd-container') renderDndView();
                if (targetId === 'reorg-container') renderReorgView();
                if (targetId === 'admin-container') {
                    renderAdminPage();
                    runAnomaliesCheck();
                }
                if (targetId === 'mindmap-container') renderInteractiveMindMap();
                if (targetId === 'priority-mindmap-container') renderPriorityMindMap();
                if (targetId === 'detail-level-container') renderDetailLevelView(); // AJOUTÉ
                if (targetId === 'analyse-offres-container') setupAnalyseOffresListeners();
            };


            const applyFilters = (tasks, { brickKey, tagKey, moduleKey, textKey }) => {
                let initialData = [...tasks];
                let filteredData;

                const selectedBricks = appState[brickKey] || [];
                const selectedTags = appState[tagKey] || [];
                const selectedModules = appState[moduleKey] || [];
                const searchTerm = (appState[textKey] || '').toLowerCase().trim();

                if (selectedBricks.length > 0) {
                    filteredData = initialData.filter(task => selectedBricks.includes(task.name));
                } else {
                    filteredData = initialData;
                }

                if (selectedTags.length === 0 && selectedModules.length === 0 && !searchTerm) {
                    return filteredData;
                }

                filteredData = filteredData.map(task => {
                    if (searchTerm && task.name.toLowerCase().includes(searchTerm)) {
                        return task;
                    }

                    const matchingFeatures = (task.features || []).filter(f => {
                        const tagMatch = selectedTags.length === 0 ||
                            (f.tags && f.tags.some(tag => selectedTags.includes(tag)));

                        const moduleMatch = selectedModules.length === 0 ||
                            selectedModules.includes(f.name);

                        const textMatch = !searchTerm ||
                            f.name.toLowerCase().includes(searchTerm) ||
                            (f.subFeatures || []).some(sf =>
                                sf.name.toLowerCase().includes(searchTerm) ||
                                (sf.description || '').toLowerCase().includes(searchTerm)
                            );

                        return tagMatch && moduleMatch && textMatch;
                    });

                    if (matchingFeatures.length > 0) {
                        return {...task, features: matchingFeatures};
                    }

                    return null;
                }).filter(Boolean);

                return filteredData;
            };

            const refreshUI = () => {
                const activeTab = document.querySelector('.content-tab:not(.hidden)');
                if (!activeTab) return;

                switch(activeTab.id) {
                    case 'controls-container': {
                        const filteredTasks = applyFilters(appState.currentTasks, {
                            brickKey: 'selectedBricksPlanning',
                            tagKey: 'selectedTagsPlanning',
                            moduleKey: 'selectedModulesPlanning',
                            textKey: 'featureFilterPlanning'
                        });
                        renderTable(filteredTasks);
                        updateCounter(filteredTasks);
                        break;
                    }
                    case 'dnd-container':
                        renderDndView();
                        break;
                    case 'reorg-container':
                        renderReorgView();
                        break;
                    case 'detail-level-container': // Rafraîchir si c'est la vue active
                        renderDetailLevelView();
                        break;
                    case 'accueil-container': renderDashboard(); break;
                    case 'mvp-container': renderMvpView(); break;
                    case 'mindmap-container': renderInteractiveMindMap(); break;
                    case 'priority-mindmap-container': renderPriorityMindMap(); break;
                }
            };

            const updateCounter = (tasks) => {
                const brickCount = tasks.length;
                let featureCount = 0;
                let subFeatureCount = 0;

                tasks.forEach(task => {
                    featureCount += (task.features || []).length;
                    subFeatureCount += (task.features || []).reduce((sum, f) => sum + (f.subFeatures?.length || 0), 0);
                });

                const counter = document.getElementById('planning-counter');
                 if (counter) {
                    counter.innerHTML = `<strong>${brickCount}</strong> appli${brickCount > 1 ? 's' : ''}
                    <span class="counter-separator">|</span> <strong>${featureCount}</strong> module${featureCount > 1 ? 's' : ''}
                    <span class="counter-separator">|</span> <strong>${subFeatureCount}</strong> fonctionnalité${subFeatureCount > 1 ? 's' : ''}`;
                }
            };

            const getPriorityClass = (priority) => {
                const priorityLower = (priority || '').toLowerCase();
                if (priorityLower.includes('p1')) return 'priority-p1';
                if (priorityLower.includes('p2')) return 'priority-p2';
                if (priorityLower.includes('p3')) return 'priority-p3';
                return 'priority-adefinir';
            };

            const renderTags = (tagsArray) => {
                if (!tagsArray || tagsArray.length === 0) return '';
                return tagsArray.map(tag => `<span class="tag-item">${tag}</span>`).join('');
            };

            const renderTable = (tasks) => {
                let tableHTML = `<table id="tasks-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Appli</th>
                            <th>Modules</th>
                            <th style="width: 20%;" class="action-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;

                if (tasks.length === 0) {
                    tableHTML += '<tr><td colspan="3" style="text-align:center; padding: 20px;">Aucune appli ou module ne correspond à votre recherche.</td></tr>';
                } else {
                    tasks.forEach((task) => {
                        let featuresHTML = '<ul class="features-list-display">';
                        let featuresToRender = task.features || [];

                        if (featuresToRender.length > 0) {
                            featuresToRender.forEach(f => {
                                const originalTask = appState.currentTasks.find(t=>t.id === task.id);
                                const originalIndex = (originalTask?.features || []).findIndex(origF => origF.name === f.name);

                                if (originalIndex === -1) return;

                                const isSelected = appState.selectedFeatures.some(sf => sf.brickId === task.id && sf.featureIndex === originalIndex);
                                const priorityClass = getPriorityClass(f.priority);
                                const hasSubFeatures = f.subFeatures && f.subFeatures.length > 0;

                                featuresHTML += `
                                 <li>
                                    <div style="display: flex; align-items: center; width: 100%;">
                                        <input type="checkbox" class="feature-checkbox" data-brick-id="${task.id}" data-feature-index="${originalIndex}" ${isSelected ? 'checked' : ''}>
                                        <span class="priority-badge ${priorityClass}">${f.priority}</span>
                                        <div class="feature-inline-view-content">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span class="feature-name-text">${f.name}</span>
                                                ${hasSubFeatures ? `<button class="view-sub-features-btn" data-brick-id="${task.id}" data-feature-index="${originalIndex}" title="Voir les fonctionnalités">${f.subFeatures.length}</button>` : ''}
                                            </div>
                                            <div class="tags-container-display">${renderTags(f.tags)}</div>
                                        </div>
                                        <button class="feature-action-btn edit-feature-btn" data-brick-id="${task.id}" data-feature-index="${originalIndex}" title="Modifier">✏️</button>
                                    </div>
                                </li>`;
                            });
                        } else {
                             featuresHTML += '<li>-</li>';
                        }
                        featuresHTML += '</ul>';

                        tableHTML += `<tr>
                            <td><strong>${task.name || ''}</strong></td>
                            <td>${featuresHTML}</td>
                            <td class="action-cell">
                                <div class="action-cell-content">
                                    <button class="add-feature-to-brick-btn" data-id="${task.id}" title="Ajouter des modules en masse">+</button>
                                    <button class="edit-task-btn" data-id="${task.id}">Modifier</button>
                                    <button class="delete-row-btn" data-id="${task.id}" title="Supprimer cette appli">×</button>
                                </div>
                            </td>
                        </tr>`;
                    });
                }
                tableHTML += `</tbody></table>`;
                tableWrapper.innerHTML = tableHTML;
            };

            const handleAddFeature = () => {
                const nameInput = document.getElementById('feature-name');
                const name = nameInput.value.trim();
                if (name) {
                    currentFeatures.push({ name: name, priority: 'À définir', tags: [], subFeatures: [] });
                    nameInput.value = '';
                    nameInput.focus();
                    showToast(`'${name}' sera ajouté lors de la sauvegarde.`, 'success');
                }
            };

            const openProjectModal = (projectId = null) => {
                elements.projectForm.reset();
                elements.projectForm.dataset.existingFeatures = '[]';
                if (projectId) {
                    const task = appState.currentTasks.find(t => t.id === projectId);
                    if (task) {
                        elements.projectModalTitle.textContent = "Modifier l'appli";
                        document.getElementById('project-id').value = task.id;
                        document.getElementById('project-name').value = task.name;
                        document.getElementById('project-description').value = task.description;
                        elements.projectForm.dataset.existingFeatures = JSON.stringify(task.features || []);
                    }
                } else {
                    elements.projectModalTitle.textContent = "Ajouter une appli";
                    document.getElementById('project-id').value = '';
                }
                currentFeatures = [];
                elements.projectModal.classList.remove('hidden');
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                const saveButton = e.target.querySelector('button[type="submit"]');
                const projectName = document.getElementById('project-name').value.trim();
                if (!projectName) {
                    showToast("Le nom de l'appli est obligatoire.", 'error');
                    return;
                }
                saveButton.disabled = true;
                const id = document.getElementById('project-id').value;
                const existingFeatures = JSON.parse(e.target.dataset.existingFeatures || '[]');
                const taskData = {
                    name: projectName,
                    description: document.getElementById('project-description').value,
                    features: [...existingFeatures, ...currentFeatures],
                    updatedAt: serverTimestamp()
                };
                try {
                    if (id) {
                        await updateDoc(doc(db, "projects", id), taskData);
                        showToast('Appli mise à jour avec succès !');
                    } else {
                        taskData.createdAt = serverTimestamp();
                        await addDoc(collection(db, "projects"), taskData);
                        showToast('Appli ajoutée avec succès !');
                    }
                    elements.projectModal.classList.add('hidden');
                } catch (error) {
                    showToast(`Erreur de sauvegarde: ${error.message}`, 'error');
                } finally {
                    saveButton.disabled = false;
                }
            };

            const handleQuickFeatureFormSubmit = async (e) => {
                e.preventDefault();
                const saveButton = e.target.querySelector('button[type="submit"]');
                const brickId = document.getElementById('quick-feature-modal-brick-id').value;
                const featureNames = document.getElementById('quick-feature-names').value;
                const featurePriority = document.getElementById('quick-feature-priority').value;
                const namesArray = featureNames.split('\n').map(name => name.trim()).filter(Boolean);
                if (namesArray.length === 0) {
                    showToast('Veuillez entrer au moins un nom de module.', 'error');
                    return;
                }
                const brick = appState.currentTasks.find(t => t.id === brickId);
                if (!brick) {
                    showToast('Erreur: Appli non trouvée.', 'error');
                    return;
                }
                saveButton.disabled = true;
                const newFeatures = namesArray.map(name => ({ name, priority: featurePriority, tags: [], subFeatures: [] }));
                try {
                    await updateDoc(doc(db, "projects", brickId), {
                        features: [...(brick.features || []), ...newFeatures],
                        updatedAt: serverTimestamp()
                    });
                    showToast(`${namesArray.length} module(s) ajouté(s) !`);
                    elements.quickFeatureModal.classList.add('hidden');
                } catch (error) {
                    showToast(`Erreur: ${error.message}`, 'error');
                } finally {
                    saveButton.disabled = false;
                }
            };

            const handleDeleteProject = async (button) => {
                const id = button.dataset.id;
                const task = appState.currentTasks.find(t => t.id === id);
                if (task && await showConfirmModal("Confirmation de suppression", `Supprimer l'appli "${task.name}" et tous ses modules ?`)) {
                    try {
                        await deleteDoc(doc(db, "projects", id));
                        showToast('Appli supprimée.', 'success');
                    } catch (error) {
                        showToast(`Erreur de suppression: ${error.message}`, 'error');
                    }
                }
            };

            const getAllFeatures = () => appState.currentTasks.flatMap((task) =>
                (task.features || []).map((feature, featureIndex) => ({
                    ...feature,
                    brickName: task.name,
                    brickId: task.id,
                    featureId: `${task.id}-${featureIndex}`
                }))
            );

            const getAllSubFeatures = () => {
                const allSubFeatures = [];
                appState.currentTasks.forEach(task => {
                    (task.features || []).forEach((feature, featureIndex) => {
                        (feature.subFeatures || []).forEach((subFeature, subFeatureIndex) => {
                            allSubFeatures.push({
                                ...subFeature,
                                parentFeatureName: feature.name,
                                parentFeaturePriority: feature.priority || 'À définir',
                                brickName: task.name,
                                brickId: task.id,
                                featureIndex: featureIndex,
                                subFeatureIndex: subFeatureIndex,
                                subFeatureId: `${task.id}-${featureIndex}-${subFeatureIndex}`
                            });
                        });
                    });
                });
                return allSubFeatures;
            };

            const renderDashboard = () => {
                let tooltipContainer = document.getElementById('kpi-tooltip-container');
                if (!tooltipContainer) {
                    tooltipContainer = document.createElement('div');
                    tooltipContainer.id = 'kpi-tooltip-container';
                    document.body.appendChild(tooltipContainer);
                }
                tooltipContainer.innerHTML = '';

                const allFeatures = getAllFeatures();
                const allSubFeatures = getAllSubFeatures();
                const kpiContainer = document.getElementById('kpi-container');

                const totalBricks = appState.currentTasks.length;
                const totalFeatures = allFeatures.length;
                const totalSubFeatures = allSubFeatures.length;
                const prioritizedFeaturesCount = allFeatures.filter(f => f.priority && f.priority !== 'À définir').length;
                const percentagePrioritized = totalFeatures > 0 ? ((prioritizedFeaturesCount / totalFeatures) * 100).toFixed(0) : 0;

                kpiContainer.innerHTML = `
                    <div class="kpi-card" data-tooltip-id="tooltip-bricks">
                        <p class="value">${totalBricks}</p>
                        <p class="label">Applis</p>
                    </div>
                    <div class="kpi-card" data-tooltip-id="tooltip-features">
                        <p class="value">${totalFeatures}</p>
                        <p class="label">Modules</p>
                    </div>
                    <div class="kpi-card" data-tooltip-id="tooltip-subfeatures">
                        <p class="value">${totalSubFeatures}</p>
                        <p class="label">Fonctionnalités</p>
                    </div>
                    <div class="kpi-card">
                        <p class="value">${percentagePrioritized}%</p>
                        <p class="label">Priorisés</p>
                    </div>
                `;

                const brickNamesList = appState.currentTasks.map(t => `<li>${t.name}</li>`).sort().join('');
                const featureNamesList = allFeatures.map(f => `<li>${f.name} (${f.brickName})</li>`).sort().join('');
                const subFeatureNamesList = allSubFeatures.map(sf => `<li>${sf.name} (${sf.parentFeatureName})</li>`).sort().join('');

                tooltipContainer.innerHTML = `
                    <div class="kpi-tooltip" id="tooltip-bricks"><ul>${brickNamesList}</ul></div>
                    <div class="kpi-tooltip" id="tooltip-features"><ul>${featureNamesList}</ul></div>
                    <div class="kpi-tooltip" id="tooltip-subfeatures"><ul>${subFeatureNamesList}</ul></div>
                `;

                document.querySelectorAll('.kpi-card[data-tooltip-id]').forEach(card => {
                    const tooltipId = card.dataset.tooltipId;
                    const tooltip = document.getElementById(tooltipId);
                    if (!tooltip) return;

                    card.addEventListener('mouseenter', (e) => {
                        const cardRect = e.target.getBoundingClientRect();
                        tooltip.style.left = `${cardRect.left + cardRect.width / 2}px`;
                        tooltip.style.top = `${cardRect.top}px`;
                        tooltip.classList.add('visible');
                    });
                    card.addEventListener('mouseleave', () => {
                        tooltip.classList.remove('visible');
                    });
                });

                const createOrUpdateChart = (chartId, type, data, options = {}) => {
                    const ctx = document.getElementById(chartId)?.getContext('2d');
                    if (!ctx) return;
                    if (appState.charts[chartId]) {
                        appState.charts[chartId].destroy();
                    }
                    appState.charts[chartId] = new Chart(ctx, { type, data, options });
                };

                const priorityColors = {
                    'P1': '#bf616a',
                    'P2': '#d08770',
                    'P3': '#ebcb8b',
                    'À définir': '#4c566a',
                    'Toutes': '#81a1c1'
                };

                const priorityCounts = allFeatures.reduce((acc, f) => {
                    const priority = f.priority || 'À définir';
                    acc[priority] = (acc[priority] || 0) + 1;
                    return acc;
                }, {});

                const priorityLabels = appState.priorities;
                const priorityData = priorityLabels.map(p => priorityCounts[p] || 0);

                createOrUpdateChart('priorityChart', 'doughnut', {
                    labels: priorityLabels,
                    datasets: [{
                        label: 'Modules',
                        data: priorityData,
                        backgroundColor: priorityLabels.map(p => priorityColors[p]),
                    }]
                }, { plugins: { legend: { position: 'right' } } });

                const filterContainer = document.getElementById('p1ByBrickFilter');
                const chartTitle = document.getElementById('p1ByBrickChartTitle');

                const priorityFilters = ['Toutes', ...appState.priorities];
                filterContainer.innerHTML = priorityFilters.map(p => `
                    <div class="legend-item ${appState.dashboardBrickChartFilter === p ? 'active' : ''}" data-priority="${p}">
                        <span class="legend-item-box" style="background-color: ${priorityColors[p]};"></span>
                        ${p}
                    </div>
                `).join('');

                let featuresForBrickChart;
                if (appState.dashboardBrickChartFilter === 'Toutes') {
                    featuresForBrickChart = allFeatures;
                    chartTitle.textContent = 'Tous les modules par Appli';
                } else {
                    featuresForBrickChart = allFeatures.filter(f => f.priority === appState.dashboardBrickChartFilter);
                    chartTitle.textContent = `Modules ${appState.dashboardBrickChartFilter} par Appli`;
                }

                const featuresByBrick = featuresForBrickChart.reduce((acc, f) => {
                    acc[f.brickName] = (acc[f.brickName] || 0) + 1;
                    return acc;
                }, {});

                createOrUpdateChart('p1ByBrickChart', 'bar', {
                    labels: Object.keys(featuresByBrick),
                    datasets: [{
                        label: `Nombre de modules (${appState.dashboardBrickChartFilter})`,
                        data: Object.values(featuresByBrick),
                        backgroundColor: priorityColors[appState.dashboardBrickChartFilter],
                    }]
                }, { plugins: { legend: { display: false } } });

                const featuresByTag = allFeatures.reduce((acc, f) => {
                    (f.tags || []).forEach(tag => {
                        acc[tag] = (acc[tag] || 0) + 1;
                    });
                    return acc;
                }, {});

                const tagLabels = Object.keys(featuresByTag);
                const numTags = tagLabels.length;
                const chartHeight = Math.max(250, 80 + numTags * 25);
                const tagChartCanvas = document.getElementById('featuresByTagChart');
                if (tagChartCanvas) {
                    tagChartCanvas.parentElement.style.height = `${chartHeight}px`;
                }

                createOrUpdateChart('featuresByTagChart', 'bar', {
                    labels: tagLabels,
                    datasets: [{
                        label: 'Nombre de modules',
                        data: Object.values(featuresByTag),
                        backgroundColor: '#a3be8c',
                    }]
                }, {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                });

                if (!filterContainer.dataset.listenerAttached) {
                    filterContainer.addEventListener('click', (e) => {
                        const legendItem = e.target.closest('.legend-item');
                        if (legendItem) {
                            const newFilter = legendItem.dataset.priority;
                            if (appState.dashboardBrickChartFilter !== newFilter) {
                                appState.dashboardBrickChartFilter = newFilter;
                                renderDashboard();
                            }
                        }
                    });
                    filterContainer.dataset.listenerAttached = 'true';
                }
            };

            const renderMvpView = () => {
                const mvpContent = document.getElementById('mvp-view-content');
                let p1Features = getAllFeatures().filter(f => f.priority === 'P1');

                if (appState.mvpFilter !== 'all') {
                    p1Features = p1Features.filter(f => f.brickName.toLowerCase().includes(appState.mvpFilter.toLowerCase()));
                }

                mvpContent.innerHTML = '';
                if (p1Features.length === 0) {
                    mvpContent.innerHTML = '<p>Aucun module de priorité P1 ne correspond à ce filtre.</p>';
                    return;
                }
                const featuresByBrick = p1Features.reduce((acc, feature) => {
                    (acc[feature.brickName] = acc[feature.brickName] || []).push(feature);
                    return acc;
                }, {});
                Object.keys(featuresByBrick).sort().forEach(brickName => {
                    const section = document.createElement('div');
                    section.className = 'mvp-brique-section';
                    const features = featuresByBrick[brickName];
                    section.innerHTML = `<h3>${brickName} (${features.length} module${features.length > 1 ? 's' : ''})</h3>`;
                    const featuresByTag = features.reduce((acc, feature) => {
                        const tags = (feature.tags && feature.tags.length > 0) ? feature.tags : ['Sans étiquette'];
                        tags.forEach(tag => {
                            (acc[tag] = acc[tag] || []).push(feature);
                        });
                        return acc;
                    }, {});
                    Object.keys(featuresByTag).sort((a, b) => (a === 'Sans étiquette') - (b === 'Sans étiquette') || a.localeCompare(b)).forEach(tag => {
                        const list = featuresByTag[tag].sort((a, b) => a.name.localeCompare(b.name)).map(feature => {
                            const hasSubFeatures = feature.subFeatures && feature.subFeatures.length > 0;
                            const featureIndex = feature.featureId.split('-')[1];
                             return `
                            <li>
                                <div style="display: flex; align-items: center; gap: 8px; flex-grow: 1;">
                                    <span>${feature.name}</span>
                                    ${hasSubFeatures ? `<button class="view-sub-features-btn" data-brick-id="${feature.brickId}" data-feature-index="${featureIndex}" title="Voir les fonctionnalités">${feature.subFeatures.length}</button>` : ''}
                                </div>
                                <div class="tags-container-display">${renderTags(feature.tags)}</div>
                            </li>`
                        }).join('');
                        section.innerHTML += `<h4 class="mvp-tag-header">${tag}</h4><ul class="mvp-features-list">${list}</ul>`;
                    });
                    mvpContent.appendChild(section);
                });
            };

            const renderDndView = () => {
                const columns = { 'P1': [], 'P2': [], 'P3': [], 'À définir': [] };

                const searchTerm = (appState.featureFilterDnd || '').toLowerCase().trim();
                const selectedBricks = appState.selectedBricksDnd || [];
                const selectedTags = appState.selectedTagsDnd || [];
                const selectedModules = appState.selectedModulesDnd || [];

                if (appState.dndViewMode === 'features') {
                    const allFeatures = getAllFeatures().filter(f => {
                        const brickMatch = selectedBricks.length === 0 || selectedBricks.includes(f.brickName);
                        const tagMatch = selectedTags.length === 0 || (f.tags && f.tags.some(tag => selectedTags.includes(tag)));
                        const moduleMatch = selectedModules.length === 0 || selectedModules.includes(f.name);
                        const textMatch = !searchTerm || f.name.toLowerCase().includes(searchTerm);

                        return brickMatch && tagMatch && moduleMatch && textMatch;
                    });

                    allFeatures.forEach(f => {
                        const priorityKey = f.priority || 'À définir';
                        const subFeaturesCount = f.subFeatures?.length || 0;
                        const countText = subFeaturesCount > 0 ? `<span class="sub-features-count" data-brick-id="${f.brickId}" data-feature-index="${f.featureId.split('-')[1]}">${subFeaturesCount} fonctionnalité${subFeaturesCount > 1 ? 's' : ''}</span>` : '';
                        const itemHTML = `<div class="dnd-item ${getPriorityClass(priorityKey).replace('priority-', '')}" data-feature-id="${f.featureId}">
                            <strong>${f.name}</strong>
                            <div class="tags-container-display">${renderTags(f.tags)}</div>
                            <span>Appli : ${f.brickName}</span>
                            ${countText}
                        </div>`;
                        (columns[priorityKey] || columns['À définir']).push(itemHTML);
                    });
                } else {
                    const allSubFeatures = getAllSubFeatures().filter(sf => {
                        const brickMatch = selectedBricks.length === 0 || selectedBricks.includes(sf.brickName);

                        const parentFeature = appState.currentTasks.find(t => t.id === sf.brickId)?.features[sf.featureIndex];
                        if (!parentFeature) return false;

                        const tagMatch = selectedTags.length === 0 || (parentFeature.tags && parentFeature.tags.some(tag => selectedTags.includes(tag)));
                        const moduleMatch = selectedModules.length === 0 || selectedModules.includes(parentFeature.name);

                        const textMatch = !searchTerm ||
                            sf.name.toLowerCase().includes(searchTerm) ||
                            sf.parentFeatureName.toLowerCase().includes(searchTerm);

                        return brickMatch && tagMatch && moduleMatch && textMatch;
                    });

                    allSubFeatures.forEach(sf => {
                        const priorityKey = sf.parentFeaturePriority;
                        const itemHTML = `<div class="dnd-item sub-feature-item ${getPriorityClass(priorityKey).replace('priority-', '')}" data-sub-feature-id="${sf.subFeatureId}">
                            <span class="parent-feature-name">${sf.parentFeatureName}</span>
                            <strong>${sf.name}</strong>
                            <span>Appli : ${sf.brickName}</span>
                        </div>`;
                        (columns[priorityKey] || columns['À définir']).push(itemHTML);
                    });
                }

                Object.entries(columns).forEach(([key, items]) => {
                    const id = `dnd-${key.toLowerCase().replace(' ', '')}`;
                    const el = document.getElementById(id.replace('àdéfinir', 'adefinir'));
                    if (el) el.innerHTML = items.join('');
                });

                document.querySelectorAll('#dnd-container .dnd-list').forEach(list => {
                    if (list.sortable) {
                        list.sortable.destroy();
                    }
                    list.sortable = new window.Sortable(list, {
                        group: 'shared-dnd', animation: 150,
                        onEnd: async (evt) => {
                            const { item, to, from } = evt;
                            const newPriority = to.dataset.priority;

                            let brickId, featureIndex;
                            if (appState.dndViewMode === 'features') {
                                [brickId, featureIndex] = item.dataset.featureId.split('-');
                            } else {
                                [brickId, featureIndex] = item.dataset.subFeatureId.split('-');
                            }

                            const brick = appState.currentTasks.find(t => t.id === brickId);
                            if (brick && brick.features[featureIndex]) {
                                const featuresCopy = JSON.parse(JSON.stringify(brick.features));

                                if (featuresCopy[featureIndex].priority !== newPriority) {
                                    featuresCopy[featureIndex].priority = newPriority;
                                    try {
                                        await updateDoc(doc(db, "projects", brickId), { features: featuresCopy });
                                        showToast("Priorité mise à jour !", "success");
                                    } catch (e) {
                                        showToast("Erreur de mise à jour.", "error");
                                        from.appendChild(item);
                                    }
                                }
                            }
                        }
                    });
                });
            };

            const renderReorgView = () => {
                const board = document.getElementById('reorg-board');
                board.innerHTML = '';
                const tooltipContainer = document.getElementById('reorg-tooltip-container');
                tooltipContainer.innerHTML = '';

                const searchTerm = (appState.featureFilterReorg || '').toLowerCase().trim();
                const selectedBricks = appState.selectedBricksReorg || [];
                const selectedTags = appState.selectedTagsReorg || [];
                const selectedModules = appState.selectedModulesReorg || [];

                const tasksToRender = appState.currentTasks.filter(task => {
                    return selectedBricks.length === 0 || selectedBricks.includes(task.name);
                });

                const featuresByBrick = tasksToRender.reduce((acc, brick) => {
                    const matchingFeatures = (brick.features || []).map((feature, index) => ({
                        ...feature,
                        brickId: brick.id,
                        featureIndex: index
                    })).filter(f => {
                        const tagMatch = selectedTags.length === 0 || (f.tags && f.tags.some(tag => selectedTags.includes(tag)));
                        const moduleMatch = selectedModules.length === 0 || selectedModules.includes(f.name);
                        const textMatch = !searchTerm ||
                            f.name.toLowerCase().includes(searchTerm) ||
                            (f.subFeatures || []).some(sf => sf.name.toLowerCase().includes(searchTerm));
                        return tagMatch && moduleMatch && textMatch;
                    });

                    if(matchingFeatures.length > 0) {
                        acc[brick.name] = matchingFeatures;
                    }
                    return acc;
                }, {});

                Object.keys(featuresByBrick).sort().forEach(brickName => {
                    const column = document.createElement('div');
                    column.className = 'dnd-column';
                    column.innerHTML = `<h3>${brickName}</h3>`;

                    featuresByBrick[brickName].forEach(feature => {
                        const featureContainer = document.createElement('div');
                        featureContainer.className = 'dnd-feature-container';
                        featureContainer.innerHTML = `<h4>${feature.name}</h4>`;

                        const subFeatureList = document.createElement('div');
                        subFeatureList.className = 'dnd-sub-feature-list';
                        subFeatureList.dataset.brickId = feature.brickId;
                        subFeatureList.dataset.featureIndex = feature.featureIndex;

                        (feature.subFeatures || []).forEach((sf, subFeatureIndex) => {
                             const subFeatureId = `${feature.brickId}-${feature.featureIndex}-${subFeatureIndex}`;
                             const hasDescription = sf.description && sf.description.trim() !== '';
                             const tooltipId = `reorg-tt-${subFeatureId}`;
                             subFeatureList.innerHTML += `
                                <div class="dnd-item sub-feature-item"
                                     data-sub-feature-id="${subFeatureId}"
                                     ${hasDescription ? `data-tooltip-id="${tooltipId}"` : ''}>
                                    <strong>${sf.name}</strong>
                                </div>`;

                             if (hasDescription) {
                                 const tooltipDiv = document.createElement('div');
                                 tooltipDiv.className = 'kpi-tooltip'; // Réutiliser la classe tooltip
                                 tooltipDiv.id = tooltipId;
                                 tooltipDiv.innerHTML = `<div class="tooltip-content">${parseMarkdown(sf.description)}</div>`;
                                 tooltipContainer.appendChild(tooltipDiv);
                             }
                        });

                        featureContainer.appendChild(subFeatureList);
                        column.appendChild(featureContainer);
                    });

                    board.appendChild(column);
                });

                document.querySelectorAll('#reorg-container .dnd-sub-feature-list').forEach(list => {
                    if (list.sortableInstance) {
                        list.sortableInstance.destroy();
                    }
                    list.sortableInstance = new window.Sortable(list, {
                        group: 'reorg-sub-features',
                        animation: 150,
                        onEnd: async (evt) => {
                             const { item, to, from } = evt;
                            const [sourceBrickId, sourceFeatureIndex, sourceSubFeatureIndex] = item.dataset.subFeatureId.split('-');
                            const destBrickId = to.dataset.brickId;
                            const destFeatureIndex = to.dataset.featureIndex;

                            if (from === to) return;

                            const sourceBrick = appState.currentTasks.find(t => t.id === sourceBrickId);
                            const destBrick = appState.currentTasks.find(t => t.id === destBrickId);

                            if (!sourceBrick || !destBrick) {
                                showToast("Erreur: Appli non trouvée.", "error"); return;
                            }

                             const originalSourceFeatureIndex = parseInt(sourceFeatureIndex, 10);
                             const originalSourceSubFeatureIndex = parseInt(sourceSubFeatureIndex, 10);
                             const originalDestFeatureIndex = parseInt(destFeatureIndex, 10);


                            const sourceFeaturesCopy = JSON.parse(JSON.stringify(sourceBrick.features));
                            const destFeaturesCopy = (sourceBrickId === destBrickId) ? sourceFeaturesCopy : JSON.parse(JSON.stringify(destBrick.features));
                            const subFeatureToMove = sourceFeaturesCopy[originalSourceFeatureIndex].subFeatures.splice(originalSourceSubFeatureIndex, 1)[0];


                            if (!subFeatureToMove) {
                                 showToast("Erreur lors du déplacement.", "error");
                                 from.appendChild(item);
                                 return;
                            }

                            if (!destFeaturesCopy[originalDestFeatureIndex].subFeatures) {
                                destFeaturesCopy[originalDestFeatureIndex].subFeatures = [];
                            }
                            destFeaturesCopy[originalDestFeatureIndex].subFeatures.push(subFeatureToMove);

                            try {
                                const batch = writeBatch(db);
                                batch.update(doc(db, "projects", sourceBrickId), { features: sourceFeaturesCopy });
                                if(sourceBrickId !== destBrickId) {
                                     batch.update(doc(db, "projects", destBrickId), { features: destFeaturesCopy });
                                }
                                await batch.commit();
                                showToast("Fonctionnalité déplacée !", "success");
                            } catch (e) {
                                showToast("Erreur de mise à jour: " + e.message, "error");
                                console.error("DnD Reorg error:", e);
                            }
                        }
                    });
                });
            };

            // ##### NOUVELLE FONCTION renderDetailLevelView #####
            const renderDetailLevelView = () => {
                const container = document.getElementById('detail-level-table-container');
                if (!container) return;

                const allFeaturesData = getAllFeatures().map(f => {
                    const subFeatures = f.subFeatures || [];
                    const totalSub = subFeatures.length;
                    const describedSub = subFeatures.filter(sf => sf.description && sf.description.trim() !== '').length;
                    const descriptionPercent = totalSub > 0 ? Math.round((describedSub / totalSub) * 100) : 0;
                    return {
                        name: f.name,
                        appName: f.brickName,
                        priority: f.priority || 'À définir',
                        totalSub: totalSub,
                        describedSub: describedSub,
                        descriptionPercent: descriptionPercent
                    };
                });

                // Simple tri (ajuster si besoin de plus complexe)
                allFeaturesData.sort((a,b) => a.name.localeCompare(b.name));

                let tableHTML = `<table id="detail-level-table">
                    <thead>
                        <tr>
                            <th>Module</th>
                            <th>Application</th>
                            <th>Priorité</th>
                            <th>Nb. Fonct.</th>
                            <th>Fonct. Décrites</th>
                        </tr>
                    </thead>
                    <tbody>`;

                if (allFeaturesData.length === 0) {
                     tableHTML += '<tr><td colspan="5" style="text-align:center; padding: 20px;">Aucun module trouvé.</td></tr>';
                } else {
                    allFeaturesData.forEach(f => {
                        let descriptionHTML = '';
                        if (f.totalSub === 0) {
                            descriptionHTML = `<span class="no-subfeatures">-</span>`;
                        } else {
                             descriptionHTML = `
                                <span class="description-text">${f.describedSub} / ${f.totalSub} (${f.descriptionPercent}%)</span>
                                <div class="description-progress-bar">
                                    <div style="width: ${f.descriptionPercent}%;"></div>
                                </div>
                             `;
                        }

                        tableHTML += `<tr>
                            <td>${f.name}</td>
                            <td>${f.appName}</td>
                            <td><span class="priority-badge ${getPriorityClass(f.priority)}">${f.priority}</span></td>
                            <td>${f.totalSub}</td>
                            <td>${descriptionHTML}</td>
                        </tr>`;
                    });
                }

                tableHTML += `</tbody></table>`;
                container.innerHTML = tableHTML;
            };

            
            
            // ##### NOUVELLE FONCTION setupAnalyseOffresListeners (Onglets & Accordéon) #####
            const setupAnalyseOffresListeners = () => {
                const container = document.getElementById('analyse-offres-container');
                if (!container || container.dataset.listenersAttached) return; // Évite les doublons

                const subTabNav = container.querySelector('.sub-tab-nav');
                const vendorNav = container.querySelector('.vendor-nav');
                const accordionContainer = container.querySelector('#grille-evaluation');

                // 1. Écouteurs pour "Grille" vs "Réponses"
                if(subTabNav) {
                    subTabNav.addEventListener('click', (e) => {
                        const targetBtn = e.target.closest('.sub-tab-link');
                        if (!targetBtn) return;
                        
                        const targetSubtab = targetBtn.dataset.subtab;
                        
                        container.querySelectorAll('.sub-tab-link').forEach(btn => btn.classList.remove('active'));
                        targetBtn.classList.add('active');
                        
                        container.querySelectorAll('.sub-content-tab').forEach(tab => {
                            tab.classList.toggle('hidden', tab.id !== targetSubtab);
                        });
                    });
                }

                // 2. Écouteurs pour les onglets Fournisseurs
                if(vendorNav) {
                    vendorNav.addEventListener('click', (e) => {
                        const targetBtn = e.target.closest('.vendor-tab-link');
                        if (!targetBtn) return;
                        
                        const targetVendor = targetBtn.dataset.vendor;
                        
                        container.querySelectorAll('.vendor-tab-link').forEach(btn => btn.classList.remove('active'));
                        targetBtn.classList.add('active');
                        
                        container.querySelectorAll('.vendor-content').forEach(tab => {
                            tab.classList.toggle('hidden', tab.id !== 'vendor-' + targetVendor);
                        });
                    });
                }
                
                // 3. Écouteurs pour l'Accordéon de la Grille
                if (accordionContainer) {
                    accordionContainer.addEventListener('click', (e) => {
                        const button = e.target.closest('.ao-accordion-button');
                        if (!button) return;
                        
                        const targetId = button.getAttribute('data-target');
                        const targetContent = document.getElementById(targetId);
                        if (!targetContent) return;
                        
                        const isOpen = targetContent.classList.contains('open');
                        
                        if (isOpen) {
                            targetContent.classList.remove('open');
                            targetContent.style.maxHeight = null;
                            button.classList.remove('open');
                        } else {
                            targetContent.classList.add('open');
                            targetContent.style.maxHeight = '10000px'; // Valeur large
                            button.classList.add('open');
                        }
                    });
                }

                container.dataset.listenersAttached = 'true'; // Marquer comme initialisé
            };

            // ##### FIN NOUVELLE FONCTION #####


            const renderInteractiveMindMap = () => {
                const container = document.getElementById('interactive-mindmap-container');
                container.innerHTML = '';
                const rootUl = document.createElement('ul');
                rootUl.className = 'mindmap-list mindmap-root';

                [...appState.currentTasks].sort((a, b) => a.name.localeCompare(b.name)).forEach(brick => {
                    const brickLi = document.createElement('li');
                    const brickNodeContainer = document.createElement('div');
                    brickNodeContainer.className = 'mindmap-node-container';

                    const brickNode = document.createElement('span');
                    brickNode.className = 'mindmap-node brick';

                    const brickToggle = document.createElement('span');
                    brickToggle.className = 'mindmap-toggle';
                    brickToggle.textContent = '▸';
                    if (!brick.features || brick.features.length === 0) brickToggle.classList.add('hidden');

                    brickNode.appendChild(brickToggle);
                    brickNode.append(brick.name);
                    brickNodeContainer.appendChild(brickNode);
                    brickLi.appendChild(brickNodeContainer);

                    if (brick.features && brick.features.length > 0) {
                        const featuresUl = document.createElement('ul');
                        featuresUl.className = 'mindmap-list';
                        featuresUl.style.display = 'none';

                        [...brick.features].sort((a, b) => a.name.localeCompare(b.name)).forEach(feature => {
                            const featureLi = document.createElement('li');
                            const featureNodeContainer = document.createElement('div');
                            featureNodeContainer.className = 'mindmap-node-container';

                            const featureNode = document.createElement('span');
                            featureNode.className = 'mindmap-node feature';

                            const featureToggle = document.createElement('span');
                            featureToggle.className = 'mindmap-toggle';
                            featureToggle.textContent = '▸';
                            if (!feature.subFeatures || feature.subFeatures.length === 0) featureToggle.classList.add('hidden');

                            featureNode.appendChild(featureToggle);
                            featureNode.append(feature.name);
                            featureNodeContainer.appendChild(featureNode);
                            featureLi.appendChild(featureNodeContainer);

                            if (feature.subFeatures && feature.subFeatures.length > 0) {
                                const subFeaturesUl = document.createElement('ul');
                                subFeaturesUl.className = 'mindmap-list';
                                subFeaturesUl.style.display = 'none';

                                [...feature.subFeatures].sort((a, b) => a.name.localeCompare(b.name)).forEach(subFeature => {
                                    const subFeatureLi = document.createElement('li');
                                    const subFeatureNode = document.createElement('span');
                                    subFeatureNode.className = 'mindmap-node sub-feature';
                                    subFeatureNode.textContent = subFeature.name;
                                    subFeatureNode.dataset.description = subFeature.description || '';
                                    subFeatureLi.appendChild(subFeatureNode);
                                    subFeaturesUl.appendChild(subFeatureLi);
                                });
                                featureLi.appendChild(subFeaturesUl);
                            }
                            featuresUl.appendChild(featureLi);
                        });
                        brickLi.appendChild(featuresUl);
                    }
                    rootUl.appendChild(brickLi);
                });
                container.appendChild(rootUl);
            };

            const renderPriorityMindMap = () => {
                const container = document.getElementById('priority-mindmap-view');
                container.innerHTML = '';
                const rootUl = document.createElement('ul');
                rootUl.className = 'mindmap-list mindmap-root';

                const featuresByPriority = getAllFeatures().reduce((acc, feature) => {
                    const priority = feature.priority || 'À définir';
                    if (!acc[priority]) acc[priority] = [];
                    acc[priority].push(feature);
                    return acc;
                }, {});

                appState.priorities.forEach(priority => {
                    if (featuresByPriority[priority] && featuresByPriority[priority].length > 0) {
                        const priorityLi = document.createElement('li');
                        const priorityNodeContainer = document.createElement('div');
                        priorityNodeContainer.className = 'mindmap-node-container';
                        const priorityNode = document.createElement('span');
                        priorityNode.className = 'mindmap-node priority';
                        const priorityToggle = document.createElement('span');
                        priorityToggle.className = 'mindmap-toggle';
                        priorityToggle.textContent = '▸';
                        priorityNode.appendChild(priorityToggle);
                        priorityNode.append(priority);
                        priorityNodeContainer.appendChild(priorityNode);
                        priorityLi.appendChild(priorityNodeContainer);

                        const featuresInPriority = featuresByPriority[priority];
                        const featuresByBrick = featuresInPriority.reduce((acc, feature) => {
                            const brickName = feature.brickName;
                            if (!acc[brickName]) acc[brickName] = [];
                            acc[brickName].push(feature);
                            return acc;
                        }, {});

                        const bricksUl = document.createElement('ul');
                        bricksUl.className = 'mindmap-list';
                        bricksUl.style.display = 'none';

                        Object.keys(featuresByBrick).sort().forEach(brickName => {
                            const brickLi = document.createElement('li');
                            const brickNodeContainer = document.createElement('div');
                            brickNodeContainer.className = 'mindmap-node-container';
                            const brickNode = document.createElement('span');
                            brickNode.className = 'mindmap-node brick';
                            const brickToggle = document.createElement('span');
                            brickToggle.className = 'mindmap-toggle';
                            brickToggle.textContent = '▸';
                            brickNode.appendChild(brickToggle);
                            brickNode.append(brickName);
                            brickNodeContainer.appendChild(brickNode);
                            brickLi.appendChild(brickNodeContainer);

                            const featuresUl = document.createElement('ul');
                            featuresUl.className = 'mindmap-list';
                            featuresUl.style.display = 'none';

                            featuresByBrick[brickName].sort((a,b) => a.name.localeCompare(b.name)).forEach(feature => {
                                const featureLi = document.createElement('li');
                                const featureNodeContainer = document.createElement('div');
                                featureNodeContainer.className = 'mindmap-node-container';
                                const featureNode = document.createElement('span');
                                featureNode.className = 'mindmap-node feature';
                                const featureToggle = document.createElement('span');
                                featureToggle.className = 'mindmap-toggle';
                                featureToggle.textContent = '▸';
                                if (!feature.subFeatures || feature.subFeatures.length === 0) featureToggle.classList.add('hidden');
                                featureNode.appendChild(featureToggle);
                                featureNode.append(feature.name);
                                featureNodeContainer.appendChild(featureNode);
                                featureLi.appendChild(featureNodeContainer);

                                if (feature.subFeatures && feature.subFeatures.length > 0) {
                                    const subFeaturesUl = document.createElement('ul');
                                    subFeaturesUl.className = 'mindmap-list';
                                    subFeaturesUl.style.display = 'none';
                                    feature.subFeatures.sort((a,b) => a.name.localeCompare(b.name)).forEach(subFeature => {
                                        const subFeatureLi = document.createElement('li');
                                        const subFeatureNode = document.createElement('span');
                                        subFeatureNode.className = 'mindmap-node sub-feature';
                                        subFeatureNode.textContent = subFeature.name;
                                        subFeatureNode.dataset.description = subFeature.description || '';
                                        subFeatureLi.appendChild(subFeatureNode);
                                        subFeaturesUl.appendChild(subFeatureLi);
                                    });
                                    featureLi.appendChild(subFeaturesUl);
                                }
                                featuresUl.appendChild(featureLi);
                            });
                            brickLi.appendChild(featuresUl);
                            bricksUl.appendChild(brickLi);
                        });
                        priorityLi.appendChild(bricksUl);
                        rootUl.appendChild(priorityLi);
                    }
                });
                container.appendChild(rootUl);
            };

            document.getElementById('main-content').addEventListener('click', (e) => {
                const targetNode = e.target.closest('.mindmap-node');
                if (!targetNode) return;

                const mindmapContainer = e.target.closest('.interactive-mindmap-container');
                if (!mindmapContainer) return;

                const parentLi = targetNode.closest('li');
                const childList = parentLi.querySelector('.mindmap-list');

                if (targetNode.classList.contains('sub-feature')) {
                     const description = targetNode.dataset.description;
                    if (description) {
                        const infoModal = document.getElementById('info-modal');
                        document.getElementById('info-modal-title').textContent = targetNode.textContent;
                        document.getElementById('info-modal-body').innerHTML = parseMarkdown(description);
                        infoModal.classList.remove('hidden');
                    }
                } else if (childList) {
                    parentLi.classList.toggle('expanded');
                    childList.style.display = childList.style.display === 'none' ? 'block' : 'none';
                    const toggle = targetNode.querySelector('.mindmap-toggle');
                    if(toggle) {
                         toggle.style.transform = parentLi.classList.contains('expanded') ? 'rotate(90deg)' : 'rotate(0deg)';
                    }
                }
            });

            const updateTagSuggestions = (tags) => {
                const datalist = document.getElementById('tag-suggestions');
                if (datalist) datalist.innerHTML = tags.map(tag => `<option value="${tag}"></option>`).join('');
            };

            const populateMultiSelect = (checkboxesId, items) => {
                const checkboxesContainer = document.getElementById(checkboxesId);
                if (!checkboxesContainer) return;
                const listElement = checkboxesContainer.querySelector('.multi-select-list');
                if (listElement) {
                    const sortedItems = [...items].sort((a, b) => a.localeCompare(b));
                    listElement.innerHTML = sortedItems.map(item => `<label><input type="checkbox" value="${item}" /> ${item}</label>`).join('');
                }
            }

            const populateFilters = () => {
                const brickNames = [...new Set(appState.currentTasks.map(t => t.name))].sort();
                const allModuleNames = [...new Set(getAllFeatures().map(f => f.name))].sort();

                populateMultiSelect('brick-checkboxes-planning', brickNames);
                populateMultiSelect('tag-checkboxes-planning', appState.tags);
                populateMultiSelect('module-checkboxes-planning', allModuleNames);

                populateMultiSelect('brick-checkboxes-dnd', brickNames);
                populateMultiSelect('tag-checkboxes-dnd', appState.tags);
                populateMultiSelect('module-checkboxes-dnd', allModuleNames);

                populateMultiSelect('brick-checkboxes-reorg', brickNames);
                populateMultiSelect('tag-checkboxes-reorg', appState.tags);
                populateMultiSelect('module-checkboxes-reorg', allModuleNames);

                updateTagSuggestions(appState.tags);
            };

            const setupMultiSelect = (containerId, checkboxesId, stateKey) => {
                const container = document.getElementById(containerId);
                const checkboxesContainer = document.getElementById(checkboxesId);
                if (!container || !checkboxesContainer) return;

                const searchInput = checkboxesContainer.querySelector('.multi-select-search');
                const listElement = checkboxesContainer.querySelector('.multi-select-list');
                const selectBoxText = container.querySelector('.select-box span');
                const defaultText = selectBoxText.textContent;

                container.querySelector('.select-box').addEventListener('click', e => {
                    e.stopPropagation();
                    const isHidden = checkboxesContainer.classList.contains('hidden');
                    document.querySelectorAll('.checkboxes:not(.hidden)').forEach(el => {
                        if (el.id !== checkboxesId) {
                            el.classList.add('hidden');
                        }
                    });
                    if (isHidden) {
                        checkboxesContainer.classList.remove('hidden');
                        searchInput.value = '';
                        listElement.querySelectorAll('label').forEach(label => label.style.display = 'block');
                        searchInput.focus();
                    } else {
                        checkboxesContainer.classList.add('hidden');
                    }
                });

                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const labels = listElement.querySelectorAll('label');
                    labels.forEach(label => {
                        const labelText = label.textContent.toLowerCase();
                        label.style.display = labelText.includes(searchTerm) ? 'block' : 'none';
                    });
                });
                searchInput.addEventListener('click', e => e.stopPropagation());


                checkboxesContainer.addEventListener('change', e => {
                    if (e.target.type === 'checkbox') {
                        const selected = Array.from(listElement.querySelectorAll('input:checked')).map(cb => cb.value);
                        appState[stateKey] = selected;

                        if (selected.length === 0) {
                            selectBoxText.textContent = defaultText;
                        } else if (selected.length === 1) {
                            selectBoxText.textContent = selected[0];
                        } else {
                            selectBoxText.textContent = `${selected.length} sélectionné(s)`;
                        }
                        refreshUI();
                    }
                });
            };


            const populatePriorityDropdowns = () => {
                const optionsHTML = appState.priorities.map(p => `<option value="${p}">${p}</option>`).join('');
                document.getElementById('edit-feature-priority').innerHTML = optionsHTML;
                document.getElementById('quick-feature-priority').innerHTML = optionsHTML;
            };

            // --- Admin Page Logic ---
            const renderAdminPage = () => {
                renderAdminList('priorities', appState.priorities, document.getElementById('priorities-list'));
                renderAdminList('tags', appState.tags, document.getElementById('tags-list'));
            };

            const renderAdminList = (type, items, listElement) => {
                if (!listElement) return;
                listElement.innerHTML = items.map(item => `
                    <li class="admin-list-item" data-name="${item}">
                        <span>${item}</span>
                        <div class="admin-item-actions">
                            <button class="edit-admin-item-btn" data-type="${type}" data-name="${item}" title="Modifier">✏️</button>
                            <button class="delete-admin-item-btn" data-type="${type}" data-name="${item}" title="Supprimer">❌</button>
                        </div>
                    </li>
                `).join('');
            };

            const runAnomaliesCheck = () => {
                const anomalies = {
                    emptyBricks: [],
                    noTags: [],
                    invalidPriority: [],
                    duplicateFeatures: []
                };
                const featureNames = {};
                appState.currentTasks.forEach(brick => {
                    if (!brick.features || brick.features.length === 0) {
                        anomalies.emptyBricks.push({ brickId: brick.id, name: brick.name });
                    }
                    (brick.features || []).forEach((feature, index) => {
                        if (!feature.tags || feature.tags.length === 0) {
                            anomalies.noTags.push({ brickId: brick.id, featureIndex: index, name: feature.name, brickName: brick.name });
                        }
                        if (!feature.priority || !appState.priorities.includes(feature.priority)) {
                            anomalies.invalidPriority.push({ brickId: brick.id, featureIndex: index, name: feature.name, brickName: brick.name });
                        }
                        const featureKey = `${brick.id}-${feature.name.toLowerCase()}`;
                        if (featureNames[featureKey]) {
                             anomalies.duplicateFeatures.push({ brickId: brick.id, featureIndex: index, name: feature.name, brickName: brick.name });
                        } else {
                            featureNames[featureKey] = true;
                        }
                    });
                });
                renderAnomalies(anomalies);
            };

            const renderAnomalies = (anomalies) => {
                const container = document.getElementById('anomalies-container');
                container.innerHTML = '';
                const createAnomalyList = (title, items, type) => {
                    if(items.length === 0) return '';
                    let listHTML = items.map(item => {
                        let info = '';
                        let dataset = '';
                        if(type === 'brick'){
                            info = `<strong>${item.name}</strong>`;
                            dataset = `data-brick-id="${item.brickId}"`;
                        } else {
                            info = `<strong>${item.name}</strong> <span>(Appli: ${item.brickName})</span>`;
                            dataset = `data-brick-id="${item.brickId}" data-feature-index="${item.featureIndex}"`;
                        }
                        return `<li class="anomaly-list-item">
                                <span class="anomaly-info">${info}</span>
                                <button class="button save-button anomaly-fix-btn" ${dataset}>Corriger</button>
                            </li>`;
                    }).join('');
                    return `<div class="anomaly-group">
                                <h4>${title} (${items.length})</h4>
                                <ul class="admin-list">${listHTML}</ul>
                            </div>`;
                };
                container.innerHTML += createAnomalyList('Applis vides', anomalies.emptyBricks, 'brick');
                container.innerHTML += createAnomalyList('Modules sans étiquette', anomalies.noTags, 'feature');
                container.innerHTML += createAnomalyList('Modules avec priorité invalide', anomalies.invalidPriority, 'feature');
                container.innerHTML += createAnomalyList('Modules en double', anomalies.duplicateFeatures, 'feature');
                if(container.innerHTML === '') {
                    container.innerHTML = '<p>Aucune anomalie détectée. Bravo !</p>';
                }
            };

            document.getElementById('anomalies-container').addEventListener('click', e => {
                const fixBtn = e.target.closest('.anomaly-fix-btn');
                if (fixBtn) {
                    const { brickId, featureIndex } = fixBtn.dataset;
                    if (featureIndex !== undefined) {
                        openEditFeatureModal(brickId, parseInt(featureIndex, 10));
                    } else {
                        openProjectModal(brickId);
                    }
                }
            });

            document.getElementById('admin-container').addEventListener('click', async e => {
                const editBtn = e.target.closest('.edit-admin-item-btn');
                const deleteBtn = e.target.closest('.delete-admin-item-btn');
                if (editBtn) {
                    currentAdminEditing = { type: editBtn.dataset.type, originalName: editBtn.dataset.name };
                    document.getElementById('admin-edit-modal-title').textContent = `Modifier "${editBtn.dataset.name}"`;
                    document.getElementById('admin-edit-name').value = editBtn.dataset.name;
                    elements.adminEditModal.classList.remove('hidden');
                }
                if (deleteBtn) {
                    const { type, name } = deleteBtn.dataset;
                    if (await showConfirmModal("Confirmation", `Supprimer "${name}" ?`)) {
                        const docRef = doc(db, "settings", type);
                        await updateDoc(docRef, { list: arrayRemove(name) });
                        showToast(`"${name}" supprimé.`, 'success');
                    }
                }
            });

            document.getElementById('add-priority-form').addEventListener('submit', async e => {
                e.preventDefault();
                const input = document.getElementById('new-priority-name');
                const newName = input.value.trim();
                if (newName) {
                    await updateDoc(doc(db, "settings", "priorities"), { list: arrayUnion(newName) });
                    showToast(`Priorité "${newName}" ajoutée.`, 'success');
                    input.value = '';
                }
            });
             document.getElementById('add-tag-form').addEventListener('submit', async e => {
                e.preventDefault();
                const input = document.getElementById('new-tag-name');
                const newName = input.value.trim();
                if (newName) {
                    await updateDoc(doc(db, "settings", "tags"), { list: arrayUnion(newName) });
                    showToast(`Étiquette "${newName}" ajoutée.`, 'success');
                    input.value = '';
                }
            });

            elements.adminEditForm.addEventListener('submit', async e => {
                e.preventDefault();
                const { type, originalName } = currentAdminEditing;
                const newName = document.getElementById('admin-edit-name').value.trim();
                if (!newName || !type || !originalName) return;

                const currentList = [...appState[type]];
                const index = currentList.indexOf(originalName);
                if (index > -1) {
                    currentList[index] = newName;
                    await updateDoc(doc(db, "settings", type), { list: currentList });
                    showToast("Élément mis à jour.", "success");
                    elements.adminEditModal.classList.add('hidden');
                }
            });
            document.getElementById('cancel-admin-edit-btn').addEventListener('click', () => elements.adminEditModal.classList.add('hidden'));

            // --- Settings Initialization ---
            const initializeSettings = async () => {
                const settings = {
                    priorities: { ref: doc(db, "settings", "priorities"), default: { list: ["P1", "P2", "P3", "À définir"] }},
                    tags: { ref: doc(db, "settings", "tags"), default: { list: [] }}
                };
                for (const key in settings) {
                    const docSnap = await getDoc(settings[key].ref);
                    if (!docSnap.exists()) {
                        await setDoc(settings[key].ref, settings[key].default);
                    }
                }
                onSnapshot(settings.priorities.ref, (doc) => {
                    appState.priorities = doc.data()?.list || [];
                    populatePriorityDropdowns();
                    if (!document.getElementById('admin-container').classList.contains('hidden')) {
                        renderAdminPage();
                    }
                });
                onSnapshot(settings.tags.ref, (doc) => {
                    appState.tags = doc.data()?.list || [];
                    populateFilters();
                    if (!document.getElementById('admin-container').classList.contains('hidden')) {
                        renderAdminPage();
                    }
                });
            };
            await initializeSettings();
            step2.classList.remove('active');
            step2.classList.add('success');

            // --- Étape 3: Chargement des données ---
            step3.classList.add('active');
            let isFirstLoad = true;
            onSnapshot(collection(db, "projects"), (querySnapshot) => {
                if(isFirstLoad){
                    step3.classList.remove('active');
                    step3.classList.add('success');
                    step4.classList.add('active');
                    loaderContainer.classList.add('hidden');
                    tableWrapper.classList.remove('hidden');
                    buttonGroupWrapper.classList.remove('hidden');
                    step4.classList.remove('active');
                    step4.classList.add('success');
                    isFirstLoad = false;
                }
                appState.currentTasks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.name.localeCompare(b.name));

                populateFilters();
                refreshUI();
            }, (error) => {
                step3.classList.add('error');
                dbStatusIndicator.classList.remove('status-ok');
                dbStatusIndicator.classList.add('status-error');
                dbStatusIndicator.title = `Erreur de lecture: ${error.message}`;
                loaderContainer.innerHTML = `<div class="error-message"><h3>Erreur de Chargement</h3><p>${error.message}</p></div>`;
            });

            setupMultiSelect('brick-filter-planning', 'brick-checkboxes-planning', 'selectedBricksPlanning');
            setupMultiSelect('tag-filter-planning', 'tag-checkboxes-planning', 'selectedTagsPlanning');
            setupMultiSelect('module-filter-planning', 'module-checkboxes-planning', 'selectedModulesPlanning');

            setupMultiSelect('brick-filter-dnd', 'brick-checkboxes-dnd', 'selectedBricksDnd');
            setupMultiSelect('tag-filter-dnd', 'tag-checkboxes-dnd', 'selectedTagsDnd');
            setupMultiSelect('module-filter-dnd', 'module-checkboxes-dnd', 'selectedModulesDnd');

            setupMultiSelect('brick-filter-reorg', 'brick-checkboxes-reorg', 'selectedBricksReorg');
            setupMultiSelect('tag-filter-reorg', 'tag-checkboxes-reorg', 'selectedTagsReorg');
            setupMultiSelect('module-filter-reorg', 'module-checkboxes-reorg', 'selectedModulesReorg');

            ['feature-filter-planning', 'feature-filter-dnd', 'feature-filter-reorg'].forEach(id => {
                const input = document.getElementById(id);
                if (!input) return;
                input.addEventListener('input', e => {
                    clearTimeout(appState.filterDebounceTimer);

                    let stateKey;
                    if (id === 'feature-filter-planning') stateKey = 'featureFilterPlanning';
                    else if (id === 'feature-filter-dnd') stateKey = 'featureFilterDnd';
                    else if (id === 'feature-filter-reorg') stateKey = 'featureFilterReorg';

                    if (stateKey) {
                        appState[stateKey] = e.target.value;
                        appState.filterDebounceTimer = setTimeout(refreshUI, 300);
                    }
                });
            });

            tableWrapper.addEventListener('click', (e) => {
                const editFeatureBtn = e.target.closest('button.edit-feature-btn');
                const editTaskBtn = e.target.closest('td.action-cell button.edit-task-btn');
                const deleteRowBtn = e.target.closest('button.delete-row-btn');
                const addFeatureBtn = e.target.closest('button.add-feature-to-brick-btn');
                const featureCheckbox = e.target.closest('.feature-checkbox');
                const viewSubFeaturesBtn = e.target.closest('.view-sub-features-btn');

                if (editFeatureBtn) {
                    openEditFeatureModal(editFeatureBtn.dataset.brickId, parseInt(editFeatureBtn.dataset.featureIndex, 10));
                } else if (editTaskBtn) {
                    openProjectModal(editTaskBtn.dataset.id);
                } else if (deleteRowBtn) {
                    handleDeleteProject(deleteRowBtn);
                } else if (addFeatureBtn) {
                    openQuickFeatureModal(addFeatureBtn.dataset.id);
                } else if (featureCheckbox) {
                    const selectedFeature = { brickId: featureCheckbox.dataset.brickId, featureIndex: parseInt(featureCheckbox.dataset.featureIndex, 10) };
                    const existingIndex = appState.selectedFeatures.findIndex(sf => sf.brickId === selectedFeature.brickId && sf.featureIndex === selectedFeature.featureIndex);
                    if (existingIndex > -1) appState.selectedFeatures.splice(existingIndex, 1);
                    else appState.selectedFeatures.push(selectedFeature);
                    updateBulkActionBar();
                } else if (viewSubFeaturesBtn) {
                    openSubFeaturesViewModal(viewSubFeaturesBtn.dataset.brickId, parseInt(viewSubFeaturesBtn.dataset.featureIndex, 10));
                }
            });

            const openSubFeaturesViewModal = (brickId, featureIndex) => {
                const brick = appState.currentTasks.find(t => t.id === brickId);
                const feature = brick?.features?.[featureIndex];
                if (!feature || !feature.subFeatures || feature.subFeatures.length === 0) {
                    return;
                }

                const modal = document.getElementById('sub-features-view-modal');
                const modalTitle = document.getElementById('sub-features-view-modal-title');
                const modalContent = document.getElementById('sub-features-view-modal-content');

                modalTitle.textContent = `Fonctionnalités de : ${feature.name}`;

                let contentHTML = '<ul class="sub-features-list">';
                feature.subFeatures.forEach(sf => {
                    contentHTML += `<li>
                        <div class="sub-feature-name">${sf.name}</div>
                        <div class="sub-feature-description">${parseMarkdown(sf.description) || '<i>Aucune description</i>'}</div>
                    </li>`;
                });
                contentHTML += '</ul>';

                modalContent.innerHTML = contentHTML;
                modal.classList.remove('hidden');
            };

            const updateBulkActionBar = () => {
                const count = appState.selectedFeatures.length;
                elements.bulkSelectionCounter.textContent = `${count} sélectionné(s)`;
                elements.bulkActionBar.classList.toggle('show', count > 0);
            };

            const openQuickFeatureModal = (brickId) => {
                const brick = appState.currentTasks.find(t => t.id === brickId);
                if(brick){
                    elements.quickFeatureForm.reset();
                    document.getElementById('quick-feature-modal-title').textContent = `Ajout rapide pour : "${brick.name}"`;
                    document.getElementById('quick-feature-modal-brick-id').value = brickId;
                    elements.quickFeatureModal.classList.remove('hidden');
                    document.getElementById('quick-feature-names').focus();
                }
            };

            const openCreateFeatureModal = () => {
                currentEditingFeature = {
                    brickId: null,
                    featureIndex: -1,
                    tags: [],
                    subFeatures: []
                };

                elements.editFeatureForm.reset();
                resetSubFeatureForm();

                document.getElementById('edit-feature-modal-title').textContent = 'Ajouter un nouveau module';

                const brickSelectorGroup = document.getElementById('edit-feature-brick-selector-group');
                const brickSelect = document.getElementById('edit-feature-brick-select');
                brickSelect.innerHTML = '<option value="">Choisir une appli...</option>' +
                    appState.currentTasks.map(task => `<option value="${task.id}">${task.name}</option>`).join('');
                brickSelectorGroup.classList.remove('hidden');

                document.getElementById('edit-feature-priority').value = 'À définir';
                const tagSelect = document.getElementById('edit-feature-tag-select');
                tagSelect.innerHTML = '<option value="">Choisir une étiquette...</option>' + appState.tags.map(tag => `<option value="${tag}">${tag}</option>`).join('');

                renderEditFeatureTags();
                renderEditSubFeatures();

                document.getElementById('delete-feature-btn-modal').classList.add('hidden');

                elements.editFeatureModal.classList.remove('hidden');
            };

            const openEditFeatureModal = (brickId, featureIndex) => {
                const brick = appState.currentTasks.find(t => t.id === brickId);
                const feature = brick?.features?.[featureIndex];
                if (!feature) return showToast("Erreur: Module non trouvé.", "error");
                currentEditingFeature = {
                    brickId,
                    featureIndex,
                    tags: [...(feature.tags || [])],
                    subFeatures: [...(feature.subFeatures || [])]
                };

                document.getElementById('edit-feature-brick-selector-group').classList.add('hidden');

                document.getElementById('edit-feature-modal-title').textContent = `Modifier le module : ${feature.name}`;
                document.getElementById('edit-feature-name').value = feature.name;
                document.getElementById('edit-feature-priority').value = feature.priority || 'À définir';

                const select = document.getElementById('edit-feature-tag-select');
                select.innerHTML = '<option value="">Choisir une étiquette...</option>' + appState.tags.map(tag => `<option value="${tag}">${tag}</option>`).join('');

                document.getElementById('delete-feature-btn-modal').classList.remove('hidden');

                renderEditFeatureTags();
                renderEditSubFeatures();
                elements.editFeatureModal.classList.remove('hidden');
            };

            const resetSubFeatureForm = () => {
                document.getElementById('sub-feature-name').value = '';
                document.getElementById('sub-feature-description').value = '';
                document.getElementById('add-sub-feature-btn').textContent = 'Ajouter';

                const cancelButton = document.getElementById('cancel-sub-feature-edit-btn');
                if (cancelButton) {
                    cancelButton.remove();
                }

                currentSubFeatureEditIndex = null;
            };

            const renderEditFeatureTags = () => {
                const container = document.getElementById('edit-feature-tags-container');
                container.innerHTML = currentEditingFeature.tags.map((tag, index) => `
                    <span class="tag-item">
                        ${tag}
                        <button type="button" class="remove-tag-btn" data-tag-index="${index}" title="Supprimer l'étiquette">×</button>
                    </span>
                `).join('');
            };

            const renderEditSubFeatures = () => {
                const list = document.getElementById('edit-sub-features-list');
                list.innerHTML = currentEditingFeature.subFeatures.map((sf, index) => `
                    <li>
                        <div class="sub-feature-details">
                            <span>${sf.name}</span>
                            ${sf.description ? `<p>${parseMarkdown(sf.description)}</p>` : ''}
                        </div>
                        <div class="sub-feature-actions">
                            <button type="button" class="edit-sub-feature-btn" data-index="${index}" title="Modifier">✏️</button>
                            <button type="button" class="delete-sub-feature-btn" data-index="${index}" title="Supprimer">&times;</button>
                        </div>
                    </li>
                `).join('');
            };

            const handleAddSubFeature = () => {
                const nameInput = document.getElementById('sub-feature-name');
                const descriptionInput = document.getElementById('sub-feature-description');
                const name = nameInput.value.trim();
                const description = descriptionInput.value.trim();

                if (!name) {
                    showToast('Le nom de la fonctionnalité est obligatoire.', 'error');
                    return;
                }

                if (currentSubFeatureEditIndex !== null) {
                    currentEditingFeature.subFeatures[currentSubFeatureEditIndex] = { name, description };
                    showToast('Fonctionnalité mise à jour !', 'success');
                } else {
                    currentEditingFeature.subFeatures.push({ name, description });
                }

                renderEditSubFeatures();
                resetSubFeatureForm();
                nameInput.focus();
            };

            document.getElementById('add-sub-feature-btn').addEventListener('click', handleAddSubFeature);

            document.getElementById('sub-feature-description').addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    handleAddSubFeature();
                }
            });

            document.getElementById('edit-sub-features-list').addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-sub-feature-btn');
                const deleteBtn = e.target.closest('.delete-sub-feature-btn');

                if (editBtn) {
                    const index = parseInt(editBtn.dataset.index, 10);
                    const subFeature = currentEditingFeature.subFeatures[index];

                    document.getElementById('sub-feature-name').value = subFeature.name;
                    document.getElementById('sub-feature-description').value = subFeature.description;
                    document.getElementById('add-sub-feature-btn').textContent = 'Mettre à jour';

                    currentSubFeatureEditIndex = index;

                    const actionsContainer = document.getElementById('sub-feature-actions-container');
                    if (!document.getElementById('cancel-sub-feature-edit-btn')) {
                        const cancelButton = document.createElement('button');
                        cancelButton.type = 'button';
                        cancelButton.id = 'cancel-sub-feature-edit-btn';
                        cancelButton.textContent = 'Annuler';
                        cancelButton.className = 'button cancel-button';
                        cancelButton.onclick = resetSubFeatureForm;
                        actionsContainer.appendChild(cancelButton);
                    }
                }

                if (deleteBtn) {
                    const index = parseInt(deleteBtn.dataset.index, 10);
                    currentEditingFeature.subFeatures.splice(index, 1);
                    renderEditSubFeatures();
                    if(index === currentSubFeatureEditIndex) {
                        resetSubFeatureForm();
                    }
                }
            });

            document.getElementById('edit-feature-tag-select').addEventListener('change', e => {
                const newTag = e.target.value;
                if (newTag && !currentEditingFeature.tags.includes(newTag)) {
                    currentEditingFeature.tags.push(newTag);
                    renderEditFeatureTags();
                }
                e.target.value = "";
            });

            document.getElementById('edit-feature-add-new-tag-btn').addEventListener('click', async () => {
                const newTag = prompt("Entrez le nom de la nouvelle étiquette :");
                if (newTag && !appState.tags.includes(newTag)) {
                    await updateDoc(doc(db, "settings", "tags"), { list: arrayUnion(newTag) });
                    showToast(`Étiquette "${newTag}" créée.`, 'success');
                    if (!currentEditingFeature.tags.includes(newTag)) {
                        currentEditingFeature.tags.push(newTag);
                        renderEditFeatureTags();
                    }
                } else if (newTag && !currentEditingFeature.tags.includes(newTag)) {
                    currentEditingFeature.tags.push(newTag);
                    renderEditFeatureTags();
                }
            });

            document.getElementById('edit-feature-tags-container').addEventListener('click', e => {
                 if (e.target.matches('.remove-tag-btn')) {
                    const tagIndex = parseInt(e.target.dataset.tagIndex, 10);
                    currentEditingFeature.tags.splice(tagIndex, 1);
                    renderEditFeatureTags();
                }
            });

            elements.editFeatureForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveButton = e.target.querySelector('button[type="submit"]');
                let { brickId, featureIndex } = currentEditingFeature;
                const newName = document.getElementById('edit-feature-name').value.trim();

                const isCreating = featureIndex === -1;
                if (isCreating) {
                    brickId = document.getElementById('edit-feature-brick-select').value;
                    if (!brickId) {
                        showToast("Veuillez sélectionner une appli parente.", "error");
                        return;
                    }
                }

                const brick = appState.currentTasks.find(t => t.id === brickId);
                if (!brick || !newName) return;

                saveButton.disabled = true;
                const featuresCopy = JSON.parse(JSON.stringify(brick.features || []));

                const newFeatureData = {
                    ...(isCreating ? {} : featuresCopy[featureIndex]),
                    name: newName,
                    priority: document.getElementById('edit-feature-priority').value,
                    tags: currentEditingFeature.tags,
                    subFeatures: currentEditingFeature.subFeatures
                };

                if (isCreating) {
                    featuresCopy.push(newFeatureData);
                } else {
                    featuresCopy[featureIndex] = newFeatureData;
                }

                try {
                    await updateDoc(doc(db, "projects", brickId), { features: featuresCopy });
                    showToast(isCreating ? "Module ajouté !" : "Module mis à jour !", "success");
                    elements.editFeatureModal.classList.add('hidden');
                } catch (error) {
                    showToast("Erreur de mise à jour.", "error");
                } finally {
                    saveButton.disabled = false;
                }
            });

            document.getElementById('delete-feature-btn-modal').addEventListener('click', async () => {
                const { brickId, featureIndex } = currentEditingFeature;
                const brick = appState.currentTasks.find(t => t.id === brickId);
                if (brick && await showConfirmModal("Confirmation", `Supprimer le module "${brick.features[featureIndex].name}" ?`)) {
                    const featuresCopy = JSON.parse(JSON.stringify(brick.features));
                    featuresCopy.splice(featureIndex, 1);
                    try {
                        await updateDoc(doc(db, "projects", brickId), { features: featuresCopy });
                        showToast("Module supprimé !", "success");
                        elements.editFeatureModal.classList.add('hidden');
                    } catch (error) {
                        showToast("Erreur de suppression.", "error");
                    }
                }
            });

            const importSubFeaturesBtn = document.getElementById('import-sub-features-btn');
            const subFeatureJsonInput = document.getElementById('sub-feature-json-import');

            importSubFeaturesBtn.addEventListener('click', () => {
                subFeatureJsonInput.click();
            });

            subFeatureJsonInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonContent = JSON.parse(e.target.result);

                        if (!Array.isArray(jsonContent)) {
                            throw new Error("Le fichier JSON doit être un tableau de fonctionnalités.");
                        }

                        const importedSubFeatures = [];

                        jsonContent.forEach(item => {
                            if (item.nom_fonctionnalite) {
                                let description = '';
                                if (item.user_story) {
                                    description += `**User Story:**\n${item.user_story}\n\n`;
                                }
                                if (item.criteres_acceptation && Array.isArray(item.criteres_acceptation)) {
                                    description += '**Critères d\'acceptation:**\n';
                                    description += item.criteres_acceptation.map(critere => `- ${critere}`).join('\n');
                                }

                                importedSubFeatures.push({
                                    name: item.nom_fonctionnalite,
                                    description: description.trim()
                                });
                            }
                        });

                        if (importedSubFeatures.length > 0) {
                            currentEditingFeature.subFeatures.push(...importedSubFeatures);
                            renderEditSubFeatures();
                            showToast(`${importedSubFeatures.length} fonctionnalité(s) importée(s) !`, 'success');
                        } else {
                            showToast('Aucune fonctionnalité valide (avec "nom_fonctionnalite") trouvée dans le fichier.', 'error');
                        }

                    } catch (error) {
                        showToast(`Erreur d'importation : ${error.message}`, 'error');
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.onerror = () => {
                    showToast('Erreur de lecture du fichier.', 'error');
                    event.target.value = '';
                };
                reader.readAsText(file);
            });


            const openBulkTagsModal = () => {
                currentBulkTags = [];
                const select = document.getElementById('bulk-tags-select');
                select.innerHTML = '<option value="">Choisir une étiquette...</option>' + appState.tags.map(tag => `<option value="${tag}">${tag}</option>`).join('');
                document.getElementById('bulk-tags-modal-title').textContent = `Gérer les étiquettes pour ${appState.selectedFeatures.length} modules`;
                renderBulkTags();
                elements.bulkTagsModal.classList.remove('hidden');
            }

            document.getElementById('bulk-manage-tags-btn').addEventListener('click', openBulkTagsModal);

            document.getElementById('bulk-tags-select').addEventListener('change', (e) => {
                const newTag = e.target.value;
                if (newTag && !currentBulkTags.includes(newTag)) {
                    currentBulkTags.push(newTag);
                    renderBulkTags();
                }
                e.target.value = "";
            });

             document.getElementById('bulk-add-new-tag-btn').addEventListener('click', async () => {
                const newTag = prompt("Entrez le nom de la nouvelle étiquette :");
                if (newTag && !appState.tags.includes(newTag)) {
                    await updateDoc(doc(db, "settings", "tags"), { list: arrayUnion(newTag) });
                    showToast(`Étiquette "${newTag}" créée.`, 'success');
                    if (!currentBulkTags.includes(newTag)) {
                        currentBulkTags.push(newTag);
                        renderBulkTags();
                    }
                }
            });

            const renderBulkTags = () => {
                const container = document.getElementById('bulk-tags-container');
                container.innerHTML = currentBulkTags.map((tag, index) => `
                    <span class="tag-item">
                        ${tag}
                        <button type="button" class="remove-tag-btn" data-tag-index="${index}" title="Ne pas appliquer cette étiquette">×</button>
                    </span>`).join('');
            };

            elements.bulkTagsModal.addEventListener('click', (e) => {
                if (e.target.matches('.remove-tag-btn')) {
                    currentBulkTags.splice(parseInt(e.target.dataset.tagIndex, 10), 1);
                    renderBulkTags();
                }
            });

            elements.bulkTagsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveButton = e.target.querySelector('button[type="submit"]');
                saveButton.disabled = true;
                const updatesByBrick = appState.selectedFeatures.reduce((acc, { brickId, featureIndex }) => {
                    if (!acc[brickId]) acc[brickId] = appState.currentTasks.find(t => t.id === brickId).features.map(f => ({...f}));
                    const tags = new Set(acc[brickId][featureIndex].tags || []);
                    currentBulkTags.forEach(tag => tags.add(tag));
                    acc[brickId][featureIndex].tags = [...tags];
                    return acc;
                }, {});
                const batch = writeBatch(db);
                Object.entries(updatesByBrick).forEach(([brickId, features]) => batch.update(doc(db, "projects", brickId), { features }));
                try {
                    await batch.commit();
                    showToast("Étiquettes mises à jour !", "success");
                    appState.selectedFeatures = [];
                    updateBulkActionBar();
                } catch (error) {
                    showToast("Erreur lors de la mise à jour.", "error");
                } finally {
                    saveButton.disabled = false;
                    elements.bulkTagsModal.classList.add('hidden');
                }
            });

            document.getElementById('bulk-move-btn').addEventListener('click', () => {
                const select = document.getElementById('bulk-move-brick-select');
                select.innerHTML = appState.currentTasks.map(task => `<option value="${task.id}">${task.name}</option>`).join('');
                document.getElementById('bulk-move-modal-title').textContent = `Déplacer ${appState.selectedFeatures.length} modules`;
                elements.bulkMoveModal.classList.remove('hidden');
            });

            elements.bulkMoveForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveButton = e.target.querySelector('button[type="submit"]');
                const destBrickId = document.getElementById('bulk-move-brick-select').value;
                if (!destBrickId) return showToast("Veuillez sélectionner une appli.", "error");
                saveButton.disabled = true;
                const featuresToMove = [];
                const updates = {};
                appState.selectedFeatures.forEach(({ brickId, featureIndex }) => {
                    if (!updates[brickId]) updates[brickId] = JSON.parse(JSON.stringify(appState.currentTasks.find(t => t.id === brickId).features));
                    featuresToMove.push(updates[brickId][featureIndex]);
                });
                appState.selectedFeatures.sort((a,b) => b.featureIndex - a.featureIndex).forEach(({brickId, featureIndex}) => {
                     updates[brickId].splice(featureIndex, 1);
                });
                if (!updates[destBrickId]) updates[destBrickId] = JSON.parse(JSON.stringify(appState.currentTasks.find(t => t.id === destBrickId).features || []));
                updates[destBrickId].push(...featuresToMove);
                const batch = writeBatch(db);
                Object.entries(updates).forEach(([brickId, features]) => batch.update(doc(db, "projects", brickId), { features }));
                try {
                    await batch.commit();
                    showToast(`${featuresToMove.length} module(s) déplacé(s) !`, "success");
                    appState.selectedFeatures = [];
                    updateBulkActionBar();
                } catch (error) {
                    showToast("Erreur lors du déplacement.", "error");
                } finally {
                    saveButton.disabled = false;
                    elements.bulkMoveModal.classList.add('hidden');
                }
            });

             document.getElementById('mvp-container').addEventListener('click', e => {
                const filterCard = e.target.closest('.mvp-filter-card');
                if (filterCard) {
                    document.querySelectorAll('.mvp-filter-card').forEach(card => card.classList.remove('active'));
                    filterCard.classList.add('active');
                    appState.mvpFilter = filterCard.dataset.filter;
                    renderMvpView();
                }
                const viewSubFeaturesBtn = e.target.closest('.view-sub-features-btn');
                if (viewSubFeaturesBtn) {
                    openSubFeaturesViewModal(viewSubFeaturesBtn.dataset.brickId, parseInt(viewSubFeaturesBtn.dataset.featureIndex, 10));
                }
            });

            document.getElementById('dnd-view-switch').addEventListener('change', (e) => {
                appState.dndViewMode = e.target.checked ? 'subFeatures' : 'features';
                renderDndView();
            });

            document.getElementById('dnd-container').addEventListener('click', (e) => {
                const subFeaturesCountBtn = e.target.closest('.sub-features-count');
                if (subFeaturesCountBtn) {
                    const { brickId, featureIndex } = subFeaturesCountBtn.dataset;
                    openSubFeaturesViewModal(brickId, parseInt(featureIndex, 10));
                }
            });

            const reorgBoard = document.getElementById('reorg-board');
            if (reorgBoard) {
                reorgBoard.addEventListener('mouseenter', (e) => {
                    const target = e.target.closest('.sub-feature-item[data-tooltip-id]');
                    if (target) {
                        const tooltipId = target.dataset.tooltipId;
                        const tooltip = document.getElementById(tooltipId);
                        if (tooltip) {
                            const targetRect = target.getBoundingClientRect();
                            tooltip.style.left = `${targetRect.left + targetRect.width / 2}px`;
                            tooltip.style.top = `${targetRect.top}px`;
                            tooltip.classList.add('visible');
                        }
                    }
                }, true);

                reorgBoard.addEventListener('mouseleave', (e) => {
                     const target = e.target.closest('.sub-feature-item[data-tooltip-id]');
                     if (target) {
                        const tooltipId = target.dataset.tooltipId;
                        const tooltip = document.getElementById(tooltipId);
                        if (tooltip) {
                            tooltip.classList.remove('visible');
                        }
                    }
                }, true);
            }

            // --- Event Listeners Setup ---
            ['cancel-project-btn', 'cancel-quick-feature-btn', 'cancel-edit-feature-modal-btn', 'cancel-bulk-tags-btn', 'cancel-bulk-move-btn', 'cancel-sub-features-view-btn', 'cancel-info-btn'].forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', e => {
                        e.target.closest('.modal-overlay').classList.add('hidden');
                        if (id === 'cancel-edit-feature-modal-btn') {
                            resetSubFeatureForm();
                        }
                    });
                }
            });
            document.getElementById('sidebar-toggle').addEventListener('click', () => document.body.classList.toggle('sidebar-collapsed'));
            document.querySelectorAll('.tab-link, .accueil-card').forEach(elem => {
                 elem.addEventListener('click', (e) => {
                    const targetTab = e.currentTarget.dataset.tab;
                    if(targetTab) {
                        switchTab(targetTab);
                    }
                });
            });
            document.getElementById('add-task-btn').addEventListener('click', () => openProjectModal());
            document.getElementById('add-module-btn').addEventListener('click', () => openCreateFeatureModal());

            elements.projectForm.addEventListener('submit', handleFormSubmit);
            elements.quickFeatureForm.addEventListener('submit', handleQuickFeatureFormSubmit);
            elements.addFeatureBtn.addEventListener('click', handleAddFeature);

            window.addEventListener('click', (e) => {
                if (!e.target.closest('.multi-select-container')) {
                    document.querySelectorAll('.checkboxes').forEach(el => el.classList.add('hidden'));
                }
            });
            
            document.querySelectorAll('.multi-select-container').forEach(el => el.addEventListener('click', e => e.stopPropagation()));

            // ##### NOUVEAUX ÉCOUTEURS POUR L'EXPORT #####
            document.getElementById('export-json-btn').addEventListener('click', () => {
                if (!appState || !appState.currentTasks || appState.currentTasks.length === 0) {
                    showToast("Aucune donnée à exporter.", "error");
                    return;
                }
                exportToJSON(appState.currentTasks);
                showToast("Export JSON généré !", "success");
            });

            document.getElementById('export-csv-btn').addEventListener('click', () => {
                 if (!appState || !appState.currentTasks || appState.currentTasks.length === 0) {
                    showToast("Aucune donnée à exporter.", "error");
                    return;
                }
                exportToCSV(appState.currentTasks);
                showToast("Export CSV généré !", "success");
            });
        };
  </script>
</body>
</html>
